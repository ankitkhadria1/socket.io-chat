{"version":3,"sources":["../src/client.es6"],"names":[],"mappings":"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","file":"src/client.es6","sourcesContent":["(function () {\n\t\"use strict\";\n\n\tvar IO           = require('socket.io'),\n\t\tdb           = require('./db'),\n\t\tChat         = require('./chat'),\n\t\tMessage      = require('./message'),\n\t\tEventEmitter = require('events').EventEmitter,\n\t\tutil         = require('util'),\n\t\t_            = require('lodash'),\n\t\tFLAGS        = require('./flags'),\n\t\tsocketMixin  = require('./socket'),\n\t\tRooms        = require('./rooms'),\n\t\tMembers      = require('./members'),\n\t\tClientError  = require('./error');\n\n\trequire('source-map-support').install();\n\n\t/**\n\t * Verifies that the contractor is to perform the action\n\t *\n\t * @param {ChatModel} chat\n\t * @param {ObjectId} performer\n\t * @param {Number} flag\n\t * @returns {Promise}\n\t */\n\tfunction validatePerformer(chat, performer, flag) {\n\t\treturn new Promise(function (resolve, reject) {\n\t\t\tvar result = false, error;\n\n\t\t\t//if (typeof performer === \"undefined\" && typeof flag === \"undefined\") {\n\t\t\t//\treturn resolve();\n\t\t\t//}\n\n\t\t\tswitch (flag) {\n\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\tresult = chat.creatorId && chat.creatorId.equals(performer);\n\t\t\t\t\terror  = new ClientError('Performer not author');\n\t\t\t\t\tbreak;\n\t\t\t\tcase FLAGS.MEMBER:\n\t\t\t\t\tresult = chat.hasMember(performer);\n\t\t\t\t\terror  = new ClientError('Performer not member');\n\t\t\t\t\tbreak;\n\t\t\t\tcase FLAGS.OTHER:\n\t\t\t\t\tresult = true;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tresult = false;\n\t\t\t\t\terror  = new Error('Undefined flag');\n\t\t\t}\n\n\t\t\treturn result ? resolve() : reject(error);\n\t\t});\n\t}\n\n\tfunction catchErrorMessage(error) {\n\t\tswitch (error.type) {\n\t\t\tcase 'validation':\n\t\t\tcase 'client':\n\t\t\t\treturn error.message;\n\t\t\tdefault:\n\t\t\t\treturn 'Unknown error';\n\t\t}\n\t}\n\n\t/**\n\t * @function socketError\n\t * @param {String} event\n\t * @param {Error|String} error\n\t * @returns {Error}\n\t */\n\tfunction socketError(event, error) {\n\t\tvar sError = new Error();\n\n\t\tsError.event = String(event);\n\n\t\tswitch (Object.prototype.toString.call(error)) {\n\t\t\tcase '[object Error]':\n\t\t\t\tsError.message = error.message;\n\t\t\t\tbreak;\n\t\t\tcase '[object String]':\n\t\t\t\tsError.message = error;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tsError.message = String(error);\n\t\t}\n\n\t\treturn sError;\n\t}\n\n\t/**\n\t * @function toUpper\n\t * @param {String} str\n\t * @returns {String}\n\t */\n\tfunction toUpper(str) {\n\t\treturn str.replace(/^(\\w)/, function (char) {\n\t\t\treturn char.toUpperCase();\n\t\t});\n\t}\n\n\t/**\n\t * @function findSocket\n\t * @param io\n\t * @param id\n\t * @param cb\n\t */\n\tfunction findSocket(io, id, cb) {\n\t\tvar ioSockets;\n\n\t\tioSockets = io.sockets.filter(function (socket) {\n\t\t\treturn socket.user && socket.user.equals(id);\n\t\t});\n\n\t\tif (ioSockets[0]) {\n\t\t\tcb(ioSockets[0]);\n\t\t}\n\t}\n\n\t/**\n\t * @class ChatClient\n\t */\n\tclass ChatClient extends EventEmitter {\n\t\t/**\n\t\t * @param server Http node.js server\n\t\t * @param {object} options\n\t\t * @param {String} options.collectionChat\n\t\t * @param {String} options.collectionMessages\n\t\t * @param {object} options.EVENTS\n\t\t * @param {String} options.eventPrefix\n\t\t */\n\t\tconstructor(server, options = {}) {\n\t\t\tsuper();\n\n\t\t\tif (!server) {\n\t\t\t\tthrow new Error('first argument required `http` server');\n\t\t\t}\n\n\t\t\tvar io, self = this;\n\t\t\tvar collectionChat, collectionChatMessages, EVENTS, eventPrefix;\n\n\t\t\tcollectionChat         = options.collectionChat || 'chats';\n\t\t\tcollectionChatMessages = options.collectionMessage || 'chats_messages';\n\n\t\t\teventPrefix = options.eventPrefix || '';\n\n\t\t\tEVENTS = {\n\t\t\t\tAUTHENTICATE:     'authenticate',\n\t\t\t\tCREATE:           'create',\n\t\t\t\tENTER:            'enter',\n\t\t\t\tLEAVE:            'leave',\n\t\t\t\tADDMEMBER:        'addMember',\n\t\t\t\tREMOVEMEMBER:     'removeMember',\n\t\t\t\tNEWMESSAGE:       'newMessage',\n\t\t\t\tNEWSYSTEMMESSAGE: 'newSystemMessage',\n\t\t\t\tCHANGETITLE:      'changeTitle',\n\t\t\t\tFINDMESSAGESLAST: 'findMessagesLast',\n\t\t\t\tFINDMESSAGESFROM: 'findMessagesFrom',\n\t\t\t\tFINDMESSAGESAT:   'findMessagesAt',\n\t\t\t\tFINDCHATS:        'findChats',\n\t\t\t\tFINDCHAT:         'findChat'\n\t\t\t};\n\n\t\t\t_.assign(EVENTS, _.pick(options.EVENTS || {}, Object.keys(EVENTS)));\n\n\t\t\tEVENTS = _.mapValues(EVENTS, function (value) {\n\t\t\t\treturn eventPrefix + value;\n\t\t\t});\n\n\t\t\tthis.EVENTS = EVENTS;\n\n\t\t\tthis.__validations = {};\n\t\t\tthis.__models      = {};\n\n\t\t\tthis.__members = new Members();\n\t\t\tthis.__rooms   = new Rooms();\n\n\t\t\tthis.__models.chat    = Chat({ collection: collectionChat });\n\t\t\tthis.__models.message = Message({ collection: collectionChatMessages });\n\n\t\t\tthis.io = io = IO(server, { maxHttpBufferSize: 1000 });\n\n\t\t\tio.on('connection', function (socket) {\n\t\t\t\tself.emit('connection', socket);\n\n\t\t\t\tsocket.on(EVENTS.AUTHENTICATE, function (data) {\n\t\t\t\t\tself.onAuthenticate(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.CREATE, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onCreate(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.ENTER, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onEnter(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.LEAVE, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onLeave(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.ADDMEMBER, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onAddMember(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.REMOVEMEMBER, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onRemoveMember(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.NEWMESSAGE, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onNewMessage(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.CHANGETITLE, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onChangeTitle(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.FINDMESSAGESLAST, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onLoadLast(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.FINDMESSAGESFROM, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onLoadFrom(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.FINDMESSAGESAT, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onLoadAt(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.FINDCHATS, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onFindChats(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on(EVENTS.FINDCHAT, function (data) {\n\t\t\t\t\tself.authorize(this) && self.onFindChat(this, data);\n\t\t\t\t});\n\n\t\t\t\tsocket.on('error', function (error) {\n\t\t\t\t\tself.emit('error', this, error.event, error);\n\t\t\t\t});\n\n\t\t\t\tsocket.on('disconnect', function () {\n\t\t\t\t\tsocket.auth = false;\n\n\t\t\t\t\tself.__members.remove(socket.user, socket);\n\t\t\t\t\tself.emit('disconnect', socket);\n\t\t\t\t});\n\n\t\t\t\t_.extend(socket, socketMixin);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Return client event names\n\t\t *\n\t\t * @returns {EVENTS}\n\t\t */\n\t\tget eventNames() {\n\t\t\treturn this.EVENTS;\n\t\t}\n\n\t\t/**\n\t\t * Set client event names\n\t\t *\n\t\t * @param {object} events\n\t\t * @returns {void}\n\t\t */\n\t\tset eventNames(events) {\n\t\t\t_.defaults(this.EVENTS, events);\n\t\t}\n\n\t\t/**\n\t\t * Return module flags\n\t\t *\n\t\t * @returns {*}\n\t\t */\n\t\tget FLAGS() {\n\t\t\treturn FLAGS;\n\t\t}\n\n\t\t/**\n\t\t * Find sockets by id`s\n\t\t *\n\t\t * @param {ObjectId|[ObjectId]} ids\n\t\t * @returns {Array}\n\t\t */\n\t\tfindSockets(ids) {\n\t\t\tvar list = [], auth = this.authorize;\n\n\t\t\tif (!(ids instanceof Array)) {\n\t\t\t\tids = [ids];\n\t\t\t}\n\n\t\t\tlist = this.io.sockets.sockets.filter(function (socket) {\n\t\t\t\treturn ids.filter(function (id) {\n\t\t\t\t\t\treturn auth(socket) && socket.user.equals(id);\n\t\t\t\t\t}).length !== 0;\n\t\t\t});\n\n\t\t\treturn list;\n\t\t}\n\n\t\t/**\n\t\t * Event on socket authenticate\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t */\n\t\tonAuthenticate(socket, data = {}) {\n\t\t\tthis.emit(this.EVENTS.AUTHENTICATE, socket, data, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\treturn socket.emitError('login', { message: error.message || error });\n\t\t\t\t}\n\n\t\t\t\tif (!this.authorize(socket)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.__members.add(socket.user, socket);\n\n\t\t\t\tsocket.emitResult('login', { user: socket.user, data: [] });\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket create new chat\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {String} data.name\n\t\t * @param {String} data.title\n\t\t */\n\t\tonCreate(socket, data = {}) {\n\t\t\tthis.create(data, socket.user)\n\t\t\t\t.then((chat) => {\n\t\t\t\t\tsocket.emitResult(this.EVENTS.CREATE, { message: 'Chat created', data: chat.toJSON() });\n\n\t\t\t\t\tthis.__rooms.addMembers(\n\t\t\t\t\t\tchat.get('_id'),\n\t\t\t\t\t\tthis.__members.get(chat.get('members'))\n\t\t\t\t\t);\n\n\t\t\t\t\tthis.__rooms.get();\n\n\t\t\t\t\tthis.findSockets()\n\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\tsocket.join(String(chat.get('_id')));\n\t\t\t\t\t\t\tsocket.emit(this.EVENTS.ENTER, { result: { data: chat.toJSON() } });\n\t\t\t\t\t\t});\n\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\treturn socket.emit(this.EVENTS.CREATE, { error: { message: error.message } });\n\t\t\t\t});\n\t\t}\n\n\t\tonEnter(socket, data = {}) {\n\n\t\t}\n\n\t\t/**\n\t\t * Event on socket leave from chat\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.chatId\n\t\t */\n\t\tonLeave(socket, data = {}) {\n\t\t\tvar chat;\n\n\t\t\tthis.model('chat').findById(data.chatId)\n\t\t\t\t.then((result) => {\n\t\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.leave(chat, socket.user)\n\t\t\t\t})\n\t\t\t\t.then((member) => {\n\t\t\t\t\tthis.__rooms.removeMember(chat.get('_id'), member);\n\t\t\t\t\tthis.__members.get(chat.get('members').concat(member))\n\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\tsocket.emitResult(this.EVENTS.LEAVE, {\n\t\t\t\t\t\t\t\tmessage: 'The member leaved', data: member\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emitError(this.EVENTS.LEAVE, { message: catchErrorMessage(error) });\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on add new member to chat\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.member\n\t\t * @param {ObjectId} data.chatId\n\t\t */\n\t\tonAddMember(socket, data = {}) {\n\t\t\tvar chat, countBefore, countAfter;\n\n\t\t\tthis.model('chat').findById(data.chatId)\n\t\t\t\t.then((result) => {\n\t\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t\t}\n\n\t\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\t\treturn this.addMember(chat, data.member, socket.user)\n\t\t\t\t})\n\t\t\t\t.then((member) => {\n\t\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (chat.systemMessages && chat.systemMessages.addMember) {\n\t\t\t\t\t\tthis.newSystemMessage(socket, {\n\t\t\t\t\t\t\twhoAdded: socket.user, whomAdded: member\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.__rooms.addMembers(chat.get('_id'), member);\n\n\t\t\t\t\tthis.__members.get(chat.get('members'))\n\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\tsocket.emitResult(this.EVENTS.ADDMEMBER, {\n\t\t\t\t\t\t\t\tmessage: 'The member added', data: member\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emitError(this.EVENTS.ADDMEMBER, { message: catchErrorMessage(error) });\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket remove member from chat\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.member\n\t\t * @param {ObjectId} data.chatId\n\t\t */\n\t\tonRemoveMember(socket, data = {}) {\n\t\t\tvar chat, countBefore, countAfter;\n\n\t\t\tthis.model('chat').findById(data.chatId)\n\t\t\t\t.then((result) => {\n\t\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t\t}\n\n\t\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\t\treturn this.removeMember(chat, data.member, socket.user)\n\t\t\t\t})\n\t\t\t\t.then((member) => {\n\t\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (chat.systemMessages && chat.systemMessages.removeMember) {\n\t\t\t\t\t\tthis.newSystemMessage(socket, {\n\t\t\t\t\t\t\twhoRemove:  socket.user,\n\t\t\t\t\t\t\twhomRemove: member\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.__rooms.removeMember(chat.get('_id'), member);\n\n\t\t\t\t\tthis.__members.get(chat.get('members').concat(member))\n\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\tsocket.emitResult(this.EVENTS.REMOVEMEMBER, {\n\t\t\t\t\t\t\t\tmessage: 'The member removed', data: member\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emitError(this.EVENTS.REMOVEMEMBER, { message: catchErrorMessage(error) });\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket push new message\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.chatId\n\t\t * @param {String} data.text\n\t\t */\n\t\tonNewMessage(socket, data = {}) {\n\t\t\tvar chat;\n\n\t\t\tthis.model('chat').findById(data.chatId)\n\t\t\t\t.then((result) => {\n\t\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.newMessage(chat, data, socket.user);\n\t\t\t\t})\n\t\t\t\t.then((message) => {\n\t\t\t\t\tthis.__members.get(chat.get('members'))\n\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\tsocket.emitResult(this.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\tmessage: 'New message',\n\t\t\t\t\t\t\t\tdata:    message.toJSON()\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emitError(this.EVENTS.NEWMESSAGE, { message: catchErrorMessage(error) });\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket load last messages of chat\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.chatId\n\t\t * @param {Number} data.count\n\t\t */\n\t\tonLoadLast(socket, data = {}) {\n\t\t\tthis.findLastMessages(data.chatId, socket.user, data.count)\n\t\t\t\t.then((messages) => {\n\t\t\t\t\tsocket.emit(this.EVENTS.FINDMESSAGESLAST, {\n\t\t\t\t\t\tresult: {\n\t\t\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\t\t\tdata:   messages\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.FINDMESSAGESLAST, error));\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket load chat messages, starting from messageId\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.chatId\n\t\t * @param {ObjectId} data.messageId\n\t\t * @param {Number} data.count\n\t\t */\n\t\tonLoadFrom(socket, data = {}) {\n\t\t\tthis.findFromMessages(data.chatId, data.messageId, socket.user, data.count)\n\t\t\t\t.then((messages) => {\n\t\t\t\t\tsocket.emit(this.EVENTS.FINDMESSAGESFROM, {\n\t\t\t\t\t\tresult: {\n\t\t\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\t\t\tdata:   messages\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.FINDMESSAGESFROM, error));\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket load chat messages, to the messageId\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @param {ObjectId} data.chatId\n\t\t * @param {ObjectId} data.messageId\n\t\t * @param {Number} data.count\n\t\t */\n\t\tonLoadAt(socket, data = {}) {\n\t\t\tthis.findAtMessages(data.chatId, data.messageId, socket.user, data.count)\n\t\t\t\t.then((messages) => {\n\t\t\t\t\tsocket.emitResult(this.EVENTS.FINDMESSAGESAT, { chatId: data.chatId, data: messages });\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.FINDMESSAGESAT, error));\n\t\t\t\t});\n\t\t}\n\n\t\tonFindChat(socket, data = {}) {\n\t\t\tthis.findChatById(socket.user, data.chatId)\n\t\t\t\t.then((chat) => {\n\t\t\t\t\tsocket.emitResult(this.EVENTS.FINDCHAT, { data: chat });\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.FINDCHAT, error));\n\t\t\t\t});\n\t\t}\n\n\t\tonFindChats(socket, data = {}) {\n\t\t\tthis.findChats(socket.user, data.count)\n\t\t\t\t.then((chats) => {\n\t\t\t\t\tsocket.emitResult(this.EVENTS.FINDCHATS, { data: chats });\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.FINDCHATS, error));\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Event on socket change title chat\n\t\t *\n\t\t * @param socket\n\t\t * @param data\n\t\t * @param {ObjectId} data.chatId\n\t\t * @param {String} data.title\n\t\t */\n\t\tonChangeTitle(socket, data = {}) {\n\t\t\tthis.model('chat').findById(data.chatId)\n\t\t\t\t.then((chat) => {\n\t\t\t\t\tif (!chat) {\n\t\t\t\t\t\treturn socket.emit(this.EVENTS.CHANGETITLE, { error: { message: 'Chat not found' } });\n\t\t\t\t\t}\n\n\t\t\t\t\tvar oldTitle = String(chat.get('title'));\n\n\t\t\t\t\tthis.changeTitle(chat, data.title, socket.user)\n\t\t\t\t\t\t.then((chat) => {\n\t\t\t\t\t\t\tif (chat.systemMessages && chat.systemMessages.changeTitle) {\n\t\t\t\t\t\t\t\tthis.newSystemMessage(chat, {\n\t\t\t\t\t\t\t\t\tchanged:  socket.user,\n\t\t\t\t\t\t\t\t\toldTitle: oldTitle,\n\t\t\t\t\t\t\t\t\tnewTitle: chat.get('title')\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.findSockets(chat.get('members'))\n\t\t\t\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\t\t\t\tsocket.emit(this.EVENTS.CHANGETITLE, {\n\t\t\t\t\t\t\t\t\t\tresult: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: 'Title changed',\n\t\t\t\t\t\t\t\t\t\t\tdata:    message.toJSON()\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.CHANGETITLE, error));\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tsocket.emit('error', socketError(this.EVENTS.CHANGETITLE, error));\n\t\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Checks the authorization of the socket\n\t\t *\n\t\t * @param {Socket} socket\n\t\t * @returns {boolean}\n\t\t */\n\t\tauthorize(socket) {\n\t\t\treturn !!socket.auth;\n\t\t}\n\n\t\t/**\n\t\t * Return model by name (chat/message)\n\t\t *\n\t\t * var ChatModel = client.model('chat');\n\t\t * new ChatModel()\n\t\t *\n\t\t * @param {String} name\n\t\t * @returns {*}\n\t\t */\n\t\tmodel(name) {\n\t\t\treturn this.__models[name];\n\t\t}\n\n\t\t/**\n\t\t * Middleware for socket.io\n\t\t *\n\t\t * @param {function} cb\n\t\t * @returns {ChatClient}\n\t\t */\n\t\tuse(cb) {\n\t\t\tthis.io.use(cb);\n\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Validate client event\n\t\t *\n\t\t * client.validate('addMember', function (socket, data, next) {\n\t\t *     if (data.flag !== client.FLAGS.MEMBER) {\n\t\t *       next(new Error('Not allowed'));\n\t\t *     }\n\t\t * })\n\t\t *\n\t\t *\n\t\t * @param {String} path\n\t\t * @param {function} cb\n\t\t * @returns {ChatClient}\n\t\t */\n\t\tvalidate(path, cb) {\n\t\t\tpath = path || 'default';\n\t\t\tcb   = cb || function () {\n\t\t\t\t};\n\n\t\t\tif (!this.__validations[path]) {\n\t\t\t\tthis.__validations[path] = [];\n\t\t\t}\n\n\t\t\tthis.__validations[path].push(cb);\n\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Create new chat\n\t\t *\n\t\t * @param {object} data\n\t\t * @param {String} data.name\n\t\t * @param {String} data.title\n\t\t * @param {ObjectId} creator\n\t\t * @returns {Promise}\n\t\t */\n\t\tcreate(data, creator) {\n\t\t\tvar chat = new (this.model('chat'))(data);\n\n\t\t\tchat.setCreator(creator);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.CREATE, { chat, creator, data })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tchat.save((error, result) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(chat);\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.CREATE, chat);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Add member to chat\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {ObjectId} member\n\t\t * @param {ObjectId} performer\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\taddMember(chat, member, performer = null, flag = FLAGS.MEMBER) {\n\t\t\tchat.addMember(member);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.ADDMEMBER, { chat, member, performer, flag })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn validatePerformer(chat, performer, flag);\n\t\t\t\t\t})\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tchat.update((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(member);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.ADDMEMBER, chat, member);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(function (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Remove member from chat\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {ObjectId} member\n\t\t * @param {ObjectId} performer\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tremoveMember(chat, member, performer = null, flag = FLAGS.AUTHOR) {\n\t\t\tchat.removeMember(member);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.REMOVEMEMBER, { chat, member, performer, flag })\n\t\t\t\t\t.then(function () {\n\t\t\t\t\t\treturn validatePerformer(chat, performer, flag);\n\t\t\t\t\t})\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tchat.update((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(member);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.REMOVEMEMBER, chat, member);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Create new message in chat\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {object} messageData\n\t\t * @param {String} messageData.text\n\t\t * @param {ObjectId} performer\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tnewMessage(chat, messageData, performer = null, flag = FLAGS.MEMBER) {\n\t\t\tvar message = null;\n\n\t\t\tmessage = new (this.model('message'))(messageData);\n\t\t\tmessage.setChat(chat);\n\t\t\tmessage.setAuthor(performer);\n\t\t\tmessage.setReceivers(chat.members);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.NEWMESSAGE, { chat, message, performer, flag })\n\t\t\t\t\t.then(function () {\n\t\t\t\t\t\treturn validatePerformer(chat, performer, flag);\n\t\t\t\t\t})\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tmessage.save((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(message);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.NEWMESSAGE, chat, message);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Change title in chat\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {String} title\n\t\t * @param {ObjectId} performer\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tchangeTitle(chat, title, performer = null, flag = FLAGS.MEMBER) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.CHANGETITLE, { chat, title, performer, flag })\n\t\t\t\t\t.then(function () {\n\t\t\t\t\t\treturn validatePerformer(chat, performer, flag)\n\t\t\t\t\t})\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tchat.setTitle(title)\n\t\t\t\t\t\t\t.update((error) => {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(chat);\n\n\t\t\t\t\t\t\t\tthis.emit(this.EVENTS.CHANGETITLE, chat, title);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Leave performer from chat\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {ObjectId} performer\n\t\t * @param flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tleave(chat, performer, flag = FLAGS.MEMBER) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.LEAVE, { chat, performer, flag })\n\t\t\t\t\t.then(function () {\n\t\t\t\t\t\treturn validatePerformer(chat, performer, flag)\n\t\t\t\t\t})\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t//chat.removeMember(performer);\n\t\t\t\t\t\tchat.update((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(performer);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.LEAVE, chat, performer);\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Create new system message (member add/remove chat, changeTitle, or event)\n\t\t *\n\t\t * @param {ChatModel} chat\n\t\t * @param {object} data\n\t\t * @returns {Promise}\n\t\t */\n\t\tnewSystemMessage(chat, data) {\n\t\t\tvar message;\n\n\t\t\tmessage = new (this.model('message'))({ text: \" \" });\n\t\t\tmessage.setChat(chat);\n\t\t\tmessage.setSystemAuthor();\n\t\t\tmessage.setReceivers(chat.members);\n\t\t\tmessage.setSystem(data);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.NEWSYSTEMMESSAGE, { chat, message, data })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tmessage.save((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(message);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.NEWSYSTEMMESSAGE, chat, message);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/** find messages */\n\n\t\t/**\n\t\t * Find last message in chat\n\t\t *\n\t\t * @param {ObjectId} chatId\n\t\t * @param {ObjectId} user\n\t\t * @param {Number} count\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tfindLastMessages(chatId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESLAST, { chatId, user, count, flag })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn this.model('message').findLast(chatId, user, count);\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve)\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Find messages in chat, start from messageId\n\t\t *\n\t\t * @param {ObjectId} chatId\n\t\t * @param {ObjectId} messageId\n\t\t * @param {ObjectId} user\n\t\t * @param {Number} count\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tfindFromMessages(chatId, messageId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESFROM, { chatId, messageId, user, count, flag })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn this.model('message').findFrom(chatId, messageId, user, count)\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject)\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Find messages in chat, to the message id\n\t\t *\n\t\t * @param {ObjectId} chatId\n\t\t * @param {ObjectId} messageId\n\t\t * @param {ObjectId} user\n\t\t * @param {Number} count\n\t\t * @param {Number} flag\n\t\t * @returns {Promise}\n\t\t */\n\t\tfindAtMessages(chatId, messageId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESAT, { chatId, messageId, user, count, flag })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn this.model('message').findAt(chatId, messageId, user, count)\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject)\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/** find chats */\n\n\t\tfindChats(user, count = 10) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGECHATS, { user, count })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn this.model('chat').findAllByMember(user)\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject)\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\tfindChatById(user, chatId) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGECHAT, { user, chatId })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\treturn this.model('chat').findByMember(chatId, user)\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject)\n\t\t\t\t\t.catch(reject);\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Used in public methods before/save update models (middleware)\n\t\t *\n\t\t * @param {String} path\n\t\t * @param {Socket} socket\n\t\t * @param {object} data\n\t\t * @returns {Promise}\n\t\t * @private\n\t\t */\n\t\t_validatePath(path, data) {\n\t\t\tvar validations = this.__validations[path],\n\t\t\t\tindex       = 0;\n\n\t\t\tif (!validations) {\n\t\t\t\tvalidations = [];\n\t\t\t}\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tfunction next(error) {\n\t\t\t\t\tif (typeof error !== \"undefined\") {\n\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar validation = validations[index];\n\n\t\t\t\t\tif (validation) {\n\t\t\t\t\t\tindex++;\n\t\t\t\t\t\treturn validation(data, next);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (index === validations.length) {\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tnext();\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Close socket.io, remove all event listeners\n\t\t *\n\t\t */\n\t\tdestroy() {\n\t\t\tthis.io.close();\n\t\t\tthis.removeAllListeners();\n\t\t}\n\t}\n\n\tmodule.exports = ChatClient;\n}());"]}