{"version":3,"sources":["../src/baseClient.es6"],"names":[],"mappings":"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","file":"baseClient.js","sourcesContent":["import IO               from 'socket.io';\nimport EventEmitter     from 'events';\nimport _                from 'underscore';\nimport deepExtend       from 'deep-extend';\nimport { debug }        from './debug';\nimport ChatModel        from './models/chat';\nimport MessageModel     from './models/message';\nimport Members          from './members';\nimport Rooms            from './rooms';\nimport Memory           from './memory';\nimport Db               from './db/index';\nimport * as chain        from './chain';\nimport * as middleWares from './middlewares';\nimport * as OPTION      from './options';\nimport * as EVENT       from './events';\n\nconst IO_CONNECTION = 'connection';\nconst SOCKET_USER   = 'user';\n\nclass BaseClient extends EventEmitter {\n\tconstructor(server, options = {}) {\n\t\tsuper();\n\n\t\tif (!server) {\n\t\t\tthrow new Error('first argument required `http` server');\n\t\t}\n\n\t\tif (!options.db) {\n\t\t\tthrow new Error('options required `db` section');\n\t\t}\n\n\t\tif (!options.db.connect) {\n\t\t\tthrow new Error('options.db required `connect`');\n\t\t}\n\n\t\t//if (!options.db.provider) {\n\t\t//\tthrow new Error('options.db required `provider` (mongodb)');\n\t\t//}\n\n\t\tthis.__middleware = [];\n\t\tthis._options     = _.clone(options);\n\t\tthis._io          = IO(server, _.extend({ maxHttpBufferSize: 1000 }, this._options[OPTION.IO] || {}));\n\t\tthis.EVENTS       = Object.create(null);\n\t\tthis.rooms        = new Rooms();\n\t\tthis.members      = new Members();\n\t}\n\n\tinitialize() {\n\t\tthis.emit('pre-initialize');\n\n\t\tthis.addEvent(EVENT.EVENTS, function (socket, data) {\n\n\t\t});\n\n\t\tthis._db = new Db(this._options.db);\n\t\tthis._io.on(IO_CONNECTION, (socket) => {\n\t\t\tlet _client = this;\n\n\t\t\tlet wrapEventCallback = function (data) {\n\t\t\t\t_client.invoke('someName', this, data);\n\t\t\t};\n\n\t\t\tfor (let name in this.EVENTS) {\n\t\t\t\tlet eventName = this.eventName(name);\n\n\t\t\t\tsocket.on(eventName, wrapEventCallback);\n\t\t\t}\n\n\t\t\tsocket.on('disconnect', () => {\n\t\t\t\tthis.logoutSocket(socket);\n\t\t\t\tthis.members.remove(socket[SOCKET_USER], socket);\n\t\t\t});\n\t\t});\n\n\t\tthis.__models = {\n\t\t\tChat:    ChatModel(this, this._options.chat),\n\t\t\tMessage: MessageModel(this, this._options.message)\n\t\t};\n\n\t\tif (this._options[OPTION.CHAT_MEMORY]) {\n\t\t\tthis._memoryChat = new Memory({\n\t\t\t\tprovider: this._options[OPTION.CHAT_MEMORY_PROVIDER],\n\t\t\t\tttl:      this._options[OPTION.CHAT_MEMORY_TTL]\n\t\t\t});\n\t\t}\n\n\t\tthis.emit('initialize');\n\t}\n\n\tget io() {\n\t\treturn this._io;\n\t}\n\n\tget model() {\n\t\treturn this.__models;\n\t}\n\n\tapplyMiddleware(_Middleware) {\n\t\tif (!_Middleware.event) {\n\t\t\tdebug('middleware not specified event name');\n\t\t\treturn this;\n\t\t}\n\n\t\t_.isFunction(_Middleware)\n\t\t\t? this.use(_Middleware.event, _Middleware)\n\t\t\t: this.use(_Middleware.event, new _Middleware(this));\n\n\n\t\treturn this;\n\t}\n\n\tuse(path, middleware) {\n\t\tif (!this.__middleware[path]) {\n\t\t\tthis.__middleware[path] = [];\n\t\t}\n\n\t\tif (_.isArray(middleware))\n\t\t\tmiddleware.forEach((_middleware) => {\n\t\t\t\tthis.__middleware[path].push(_middleware);\n\t\t\t});\n\n\t\tif (middleware.exec)\n\t\t\tif (_.isArray(middleware.exec))\n\t\t\t\tmiddleware.exec.forEach((_middleware) => {\n\t\t\t\t\tthis.__middleware[path].push(_middleware);\n\t\t\t\t});\n\t\t\telse\n\t\t\t\tthis.__middleware[path].push(middleware.exec);\n\n\t\treturn this;\n\t}\n\n\tunuse(path, callback) {\n\t\tif (!(path in this.__middleware)) {\n\t\t\tdebug('unuse: path not found');\n\t\t\treturn this;\n\t\t}\n\n\t\tlet index = this.__middleware.indexOf(callback);\n\n\t\tif (index !== -1) {\n\t\t\tthis.__middleware.splice(index, 1);\n\t\t} else {\n\t\t\tdebug('unuse: not found callback, already removed?')\n\t\t}\n\n\t\treturn this;\n\t}\n\n\texecMiddleware(path, data) {\n\t\tvar middleware = this.__middleware[path] || [];\n\n\t\treturn chain.exec(middleware, data);\n\t}\n\n\tinvoke(name, socket, data) {\n\t\tlet promise = (resolve, reject) => {\n\n\t\t\tif (!(name in this.EVENTS)) {\n\t\t\t\treturn reject();\n\t\t\t}\n\n\n\t\t};\n\n\t\treturn new Promise(promise);\n\t}\n\n\taddEvent(name) {\n\t\tvar callbacks = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (!this.EVENTS[name]) {\n\t\t\tthis.EVENTS[name] = [];\n\t\t}\n\n\t\tcallbacks.forEach(function (callback) {\n\t\t\tif (callback instanceof Function) {\n\t\t\t\tthis.EVENTS[name].push(callback)\n\t\t\t}\n\t\t});\n\n\t\treturn this;\n\t}\n\n\tremoveEvent(name) {\n\t\tvar callbacks = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (!this.EVENTS[name]) {\n\t\t\tthis.EVENTS[name] = [];\n\t\t}\n\n\t\tcallbacks.forEach(function (callback) {\n\t\t\tlet indexCb;\n\n\t\t\tif ((indexCb = this.EVENTS[name].indexOf(callback)) !== -1) {\n\t\t\t\tthis.EVENTS[name].splice(indexCb, 1);\n\t\t\t}\n\t\t});\n\n\t\treturn this;\n\t}\n\n\teventName(name) {\n\t\tif (this._options[OPTION.EVENT_PREFIX]) {\n\t\t\tlet prefix = this._options[OPTION.EVENT_PREFIX];\n\n\t\t\treturn name.replace(/^(\\w)/, function (firstChar) {\n\t\t\t\treturn prefix + firstChar.toUpperCase();\n\t\t\t});\n\t\t}\n\n\t\treturn name;\n\t}\n\n\tsocketAuthorized(socket) {\n\t\treturn socket && (socket.auth === true) && socket[SOCKET_USER];\n\t}\n\n\tlogoutSocket(socket) {\n\t\tdelete socket.auth;\n\t\tdelete socket[SOCKET_USER];\n\t}\n\n\tgetChat(id) {\n\t\treturn new Promise((resolve, rejcet) => {\n\t\t\tif (OPTION.CHAT_MEMORY in this._options) {\n\n\t\t\t} else {\n\t\t\t\tthis.model.Chat.findById(id).then((chat) => {\n\t\t\t\t\tresolve(chat);\n\t\t\t\t}).catch(reject);\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport default BaseClient;"]}