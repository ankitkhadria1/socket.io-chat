{"version":3,"sources":["/home/demitriy/work/chat/lib/model.js"],"names":[],"mappings":"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","file":"model-compiled.js","sourcesContent":["'use strict';\n\nvar _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();\n\nvar _get = function get(_x2, _x3, _x4) { var _again = true; _function: while (_again) { desc = parent = getter = undefined; _again = false; var object = _x2,\n    property = _x3,\n    receiver = _x4; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { _x2 = parent; _x3 = property; _x4 = receiver; _again = true; continue _function; } } else if ('value' in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } } };\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== 'function' && superClass !== null) { throw new TypeError('Super expression must either be null or a function, not ' + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) subClass.__proto__ = superClass; }\n\nvar _ = require('lodash'),\n    db = require('./db'),\n    Validator = require('jsonschema').Validator,\n    EventEmitter = require('events').EventEmitter;\n\nvar sl = Array.prototype.slice;\n\nvar Model = (function (_EventEmitter) {\n\tfunction Model() {\n\t\tvar _this2 = this;\n\n\t\tvar props = arguments[0] === undefined ? {} : arguments[0];\n\n\t\t_classCallCheck(this, Model);\n\n\t\t_get(Object.getPrototypeOf(Model.prototype), 'constructor', this).call(this);\n\n\t\t_.each(this.defaults(), function (value, key) {\n\t\t\t_this2[key] = props[key] ? props[key] : value;\n\t\t});\n\t}\n\n\t_inherits(Model, _EventEmitter);\n\n\t_createClass(Model, [{\n\t\tkey: 'save',\n\t\tvalue: function save() {\n\t\t\tvar _this3 = this;\n\n\t\t\tvar cb = sl.call(arguments, -1)[0];\n\n\t\t\tif (this.isValid()) {\n\t\t\t\tthis.set('_id', new db.ObjectID());\n\t\t\t\tthis.emit('beforeSave');\n\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tconnect.collection(_this3.collection()).insertOne(_this3.toJSON(), {}, cb);\n\t\t\t\t\t_this3.emit('save');\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tcb(new Error(this.validationError.message));\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\t}, {\n\t\tkey: 'update',\n\t\tvalue: function update() {\n\t\t\tvar _this4 = this;\n\n\t\t\tvar data, cb, modelId;\n\n\t\t\tmodelId = db.ObjectID(this.get('_id'));\n\t\t\tdata = this.toJSON();\n\t\t\tcb = sl.call(arguments, -1)[0];\n\n\t\t\tdelete data._id;\n\n\t\t\tdb.getConnect(function (connect) {\n\t\t\t\tconnect.collection(_this4.collection()).updateOne({ _id: modelId }, data, cb);\n\t\t\t});\n\n\t\t\treturn this;\n\t\t}\n\t}, {\n\t\tkey: 'isValid',\n\t\tvalue: function isValid() {\n\t\t\tvar result;\n\n\t\t\tresult = this.validate();\n\n\t\t\tif (result) {\n\t\t\t\tthis.validationError = result;\n\t\t\t}\n\n\t\t\treturn !result;\n\t\t}\n\t}, {\n\t\tkey: 'validate',\n\t\tvalue: function validate() {\n\t\t\tvar validator = new Validator(),\n\t\t\t    result = validator.validate(this.toJSON(), this.getSchema());\n\n\t\t\tthis.emit('beforeValidate');\n\n\t\t\tif (result.errors.length) {\n\t\t\t\treturn new Error(result.errors[0].stack);\n\t\t\t}\n\n\t\t\tthis.emit('validate');\n\n\t\t\treturn null;\n\t\t}\n\t}, {\n\t\tkey: 'setSchema',\n\t\tvalue: function setSchema(schema) {\n\t\t\tthis.schema = schema;\n\t\t}\n\t}, {\n\t\tkey: 'getSchema',\n\t\tvalue: function getSchema() {\n\t\t\treturn this.schema;\n\t\t}\n\t}, {\n\t\tkey: 'toJSON',\n\t\tvalue: function toJSON() {\n\t\t\treturn _.clone(_.pick(this, Object.keys(this.defaults())));\n\t\t}\n\t}, {\n\t\tkey: 'set',\n\t\tvalue: function set(key, value) {\n\t\t\tvar _this5 = this;\n\n\t\t\tif (arguments.length === 1) {\n\t\t\t\t_.each(key, function (value, key) {\n\t\t\t\t\t_this5.set(key, value);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\t\tthis[key] = value;\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\t}, {\n\t\tkey: 'get',\n\t\tvalue: function get(key) {\n\t\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\t\treturn this[key];\n\t\t\t}\n\t\t}\n\t}]);\n\n\treturn Model;\n})(EventEmitter);\n\nmodule.exports = Model;"]}