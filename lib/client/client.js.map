{"version":3,"sources":["../../src/client/client.es6"],"names":[],"mappings":"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","file":"client.js","sourcesContent":["import { debug }        from '../debug';\nimport { unique_m }        from '../utils';\nimport BaseClient       from './base';\nimport * as middleWares from '../middlewares';\nimport * as EVENT       from '../events';\nimport * as OPTION      from '../options';\n\nfunction onError(error) {\n\tdebug(error.stack);\n}\n\nclass Client extends BaseClient {\n\tconstructor(server, options) {\n\t\tsuper(server, options);\n\n\t\tthis.onAuthenticate.priority   = 100;\n\t\tthis.socketAuthorized.priority = 0;\n\n\t\tthis\n\t\t\t.addEvent(EVENT.AUTHENTICATE, this.onAuthenticate)\n\t\t\t.addEvent(EVENT.NEW_CHAT, this.socketAuthorized, this.onNewChat)\n\t\t\t.addEvent(EVENT.NEW_MESSAGE, this.socketAuthorized, this.onNewMessage)\n\t\t\t.addEvent(EVENT.FIND_CHATS, this.socketAuthorized, this.onFindChats)\n\t\t\t.addEvent(EVENT.FIND_LAST_MESSAGES, this.socketAuthorized, this.onFindLastMessages)\n\t\t\t.addEvent(EVENT.WRITE_MESSAGE, this.socketAuthorized, this.onWriteMessage)\n\t\t\t//.addEvent(EVENT.START_WRITE, this.socketAuthorized, this.onStartWrite)\n\t\t\t//.addEvent(EVENT.END_WRITE, this.socketAuthorized, this.onEndWrite)\n\t\t\t//.addEvent(EVENT.FOCUS, this.socketAuthorized, this.onFocus)\n\t\t\t//.addEvent(EVENT.BLUR, this.socketAuthorized, this.onBlur)\n\t\t;\n\n\t\tif (this.options[OPTION.CHAT_RECORD_COUNT_MESSAGES]) {\n\t\t\tthis.applyMiddleware(middleWares.chatRecordCountMessages);\n\t\t}\n\n\t\tif (this.options[OPTION.CHAT_RECORD_LAST_MESSAGES]) {\n\t\t\tthis.applyMiddleware(middleWares.chatRecordLastMessages);\n\t\t}\n\n\t\tif (this.options[OPTION.CHAT_SINGLE_PRIVATE]) {\n\t\t\tthis.applyMiddleware(middleWares.chatSinglePrivate);\n\t\t}\n\n\t\tif (this.options[OPTION.CHAT_NEW_ON_GROUP]) {\n\t\t\tthis.applyMiddleware(middleWares.chatNewOnGroup);\n\t\t}\n\n\t\t!options.delayInitialize && this.initialize();\n\n\t\tthis.on('onAuthenticate', function (options) {\n\t\t\tthis.findChatsUnread({}, options.socket.user)\n\t\t\t\t.then((chats) => {\n\t\t\t\t\tchats.forEach(function (chat) {\n\t\t\t\t\t\toptions.socket.join(String(chat._id));\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}.bind(this));\n\t}\n\n\tonAuthenticate(socket, data, next) {\n\t\tsocket.emit(this.eventName(EVENT.AUTHENTICATE), { result: { user: data._id } });\n\t\tthis.members.add(data._id, socket);\n\t\tthis.emit('onAuthenticate', { socket })\n\t}\n\n\tonNewChat(socket, options, next) {\n\t\tthis.newChat(options, socket.user)\n\t\t\t.then((options) => {\n\t\t\t\t//this.joinQueue.resolve(options.chat.get('members'));\n\n\t\t\t\treturn this.respond(socket).newChat(options);\n\t\t\t})\n\t\t\t.then(function () {\n\t\t\t\tnext();\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tonNewMessage(socket, options, next) {\n\t\tthis.newMessage(options, socket.user)\n\t\t\t.then((options) => {\n\t\t\t\tlet room = this.namespace.to(String(options.chat._id));\n\n\t\t\t\tif (!room._connectedChecked) {\n\t\t\t\t\tObject.defineProperty(room, '_connectedChecked', {\n\t\t\t\t\t\tenumerable: false,\n\t\t\t\t\t\tvalue:      true\n\t\t\t\t\t});\n\n\t\t\t\t\tlet roomConnected = [];\n\n\t\t\t\t\tObject.keys(room.connected).forEach(function (key) {\n\t\t\t\t\t\troomConnected.push(room.connected[key].user);\n\t\t\t\t\t});\n\n\t\t\t\t\tunique_m(roomConnected);\n\n\t\t\t\t\tif (options.chat.getMembersIds().length !== roomConnected.length) {\n\t\t\t\t\t\tlet members = this.members.get(options.chat.getMembersIds());\n\n\t\t\t\t\t\tmembers.forEach(function (member) {\n\t\t\t\t\t\t\tmember.join(String(options.chat._id));\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn this.respond(room).newMessage(options);\n\t\t\t})\n\t\t\t.then(function () {\n\t\t\t\t//next();\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tonFindChats(socket, options, next) {\n\t\tthis.findChats(options, socket.user)\n\t\t\t.then((data) => {\n\t\t\t\treturn this.respond(socket).findChats(data);\n\t\t\t})\n\t\t\t.then(function () {\n\t\t\t\tnext();\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tonFindLastMessages(socket, options, next) {\n\t\tthis.findLastMessages(options, socket.user)\n\t\t\t.then((data) => {\n\t\t\t\treturn this.respond(socket).findLastMessages(data)\n\t\t\t})\n\t\t\t.then(function () {\n\t\t\t\tnext();\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tonWriteMessage(socket, options, next) {\n\t\tif (socket.rooms.indexOf(options.chatId) !== -1) {\n\t\t\tthis.respond(this.namespace.to(options.chatId)).writeMessage({ chatId: options.chatId, isWrite: options.isWrite });\n\t\t}\n\t}\n\n\tnewChat(options = {}, user = null) {\n\t\t// TODO: first message\n\n\t\treturn this.preMiddleware(EVENT.NEW_CHAT, options)\n\t\t\t.then((postOptions) => {\n\t\t\t\tlet chat = new this.model.Chat(options.data);\n\n\t\t\t\tchat.setCreator(user);\n\n\t\t\t\treturn chat.save();\n\t\t\t})\n\t\t\t.then((chat) => {\n\t\t\t\treturn { chat, user }\n\t\t\t})\n\t\t\t.then((options) => {\n\t\t\t\treturn this.postMiddleware(EVENT.NEW_CHAT, options)\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tnewMessage(options = {}, user = null) {\n\t\tlet chat;\n\n\t\treturn this.preMiddleware(EVENT.NEW_CHAT, options)\n\t\t\t.then(() => {\n\t\t\t\treturn this.model.Chat.findOne({ _id: options.data.chatId, 'members._id': String(user) }).exec();\n\t\t\t})\n\t\t\t.then((result) => {\n\t\t\t\tchat = result;\n\n\t\t\t\tif (chat) {\n\t\t\t\t\tlet message = new this.model.Message(options.data);\n\n\t\t\t\t\tmessage.setChat(chat);\n\t\t\t\t\tmessage.setAuthor(user);\n\t\t\t\t\tmessage.setType('user');\n\n\t\t\t\t\treturn message.save();\n\t\t\t\t}\n\t\t\t\t// TODO: what if else ?\n\t\t\t})\n\t\t\t.then((message) => {\n\t\t\t\treturn { chat, message, user };\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tfindChats(options = {}, user = null) {\n\t\treturn this.preMiddleware(EVENT.FIND_CHATS, options)\n\t\t\t.then(() => {\n\t\t\t\treturn this.model.Chat.find({ 'members._id': String(user) })\n\t\t\t\t\t.sort({ lastMessageAt: 1 })\n\t\t\t\t\t.exec({ lean: 1 })\n\t\t\t})\n\t\t\t.then((results) => {\n\t\t\t\treturn this.postMiddleware(EVENT.FIND_CHATS, results);\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tfindChatsUnread(options = {}, user = null) {\n\t\treturn this.preMiddleware(EVENT.FIND_CHATS_UNREAD, options)\n\t\t\t.then(() => {\n\t\t\t\treturn this.model.Chat.find({ 'members._id': String(user), 'members.unreadCount': { $gt: 0 } })\n\t\t\t\t\t.exec({ lean: 1 })\n\t\t\t})\n\t\t\t.then((results) => {\n\t\t\t\treturn this.postMiddleware(EVENT.FIND_CHATS_UNREAD, results);\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tfindLastMessages(options = {}, user = null) {\n\t\treturn this.preMiddleware(EVENT.FIND_LAST_MESSAGES, options)\n\t\t\t.then(() => {\n\t\t\t\treturn this.model.Message.find({\n\t\t\t\t\tchatId:    String(options.chatId),\n\t\t\t\t\treceivers: String(user),\n\t\t\t\t\tdeleted:   { $nin: [user] }\n\t\t\t\t})\n\t\t\t\t\t.sort({ createdAt: -1 })\n\t\t\t\t\t.limit(3)\n\t\t\t\t\t.exec({ lean: 1 })\n\t\t\t})\n\t\t\t.then((results) => {\n\t\t\t\tresults.sort(function (result) {\n\t\t\t\t\treturn result.createdAt;\n\t\t\t\t});\n\n\t\t\t\treturn this.postMiddleware(EVENT.FIND_LAST_MESSAGES, {\n\t\t\t\t\tchatId:   String(options.chatId),\n\t\t\t\t\tmessages: results\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch(onError);\n\t}\n\n\tsystemNotification() {\n\t}\n\n\tauthorize(socket) {\n\n\t}\n}\n\nexport default Client;"]}