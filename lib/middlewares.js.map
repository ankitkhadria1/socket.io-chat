{"version":3,"sources":["../src/middlewares.es6"],"names":[],"mappings":"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","file":"middlewares.js","sourcesContent":["import deepExtend  from 'deep-extend';\nimport * as EVENT  from './events';\nimport * as OPTION from './options';\n\nclass Middleware {\n\tconstructor() {\n\n\t}\n}\n\nexport default Middleware;\n\nexport class chatRecordLastMessages extends Middleware {\n\tstatic event (){\n\t\treturn EVENT.NEW_MESSAGE;\n\t}\n\n\tconstructor(client) {\n\t\tsuper();\n\n\t\tthis.client = client;\n\t\tthis.count = this.client._options[OPTION.CHAT_RECORD_LAST_MESSAGES_COUNT] || 10;\n\n\t\tdeepExtend(client._options, {\n\t\t\tchat: {\n\t\t\t\tschema: {\n\t\t\t\t\tproperties: {\n\t\t\t\t\t\tcountMessages: {\n\t\t\t\t\t\t\t\"type\":    \"number\",\n\t\t\t\t\t\t\t'default': \"Number\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\n\texec(options, next) {\n\t\tif (!options.chat.lastMessages) {\n\t\t\toptions.chat.set('lastMessages', []);\n\t\t}\n\n\t\tif (options.chat.lastMessages.length > this.count) {\n\t\t\toptions.chat.$pull('lastMessages.0')\n\t\t}\n\n\t\toptions.chat.$push('lastMessages', options.message.toJSON());\n\n\t\tnext();\n\t}\n}\n\nexport class chatRecordCountMessages extends Middleware {\n\tstatic event (){\n\t\treturn EVENT.NEW_MESSAGE;\n\t}\n\n\tconstructor(client) {\n\t\tsuper();\n\t}\n\n\texec(options, next) {\n\t\tif (typeof options.chat.countMessages === 'undefined' || options.chat.countMessages === null) {\n\t\t\toptions.chat.set('countMessages', 0);\n\t\t}\n\n\t\toptions.chat.countMessages++;\n\t\toptions.chat.save().then(function () {\n\t\t\tdebug('save count messages');\n\t\t});\n\n\t\tnext();\n\t}\n}\n\nexport class chatSinglePrivate extends Middleware {\n\tstatic event (){\n\t\treturn EVENT.NEW_CHAT;\n\t}\n\n\tconstructor(client) {\n\t\tsuper();\n\t\tthis.client = client;\n\t}\n\n\texec(options, next) {\n\t\tif (options.chat.type === 'private') {\n\t\t\tthis.client.model.Chat.findEqual(options.chat)\n\t\t\t\t.then(function (equalChat) {\n\t\t\t\t\tequalChat && (options.chat = equalChat);\n\t\t\t\t\tequalChat && (options.chat.isEqual = true);\n\t\t\t\t\tnext();\n\t\t\t\t})\n\t\t\t\t.catch(next);\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t}\n}\n\nexport class chatNewOnGroup extends Middleware {\n\tstatic event (){\n\t\treturn EVENT.ADD_MEMBER;\n\t}\n\n\tconstructor(client) {\n\t\tsuper();\n\t\tthis.client = client;\n\t}\n\n\texec(options, next) {\n\t\tvar chat;\n\n\t\tif (options.chat.type === 'group' && options.chat.members.length === 2) {\n\t\t\tchat = new this.client.model.Chat();\n\t\t\tchat.set(options.chat.toJSON());\n\n\t\t\toptions.chat = chat;\n\t\t}\n\n\t\tnext();\n\t}\n}"]}