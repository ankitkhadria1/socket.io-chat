{"version":3,"sources":["../src/queryResolver.es6"],"names":[],"mappings":"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","file":"queryResolver.js","sourcesContent":["import extend    from 'extend';\nimport debugBase from 'debug';\nimport _         from 'underscore';\n\nclass QueryResolver {\n\tconstructor(Model) {\n\t\tthis.__Model = Model;\n\n\t\tthis.__query    = {};\n\t\tthis.__criteria = {};\n\t\tthis.__select   = {};\n\t\tthis.__limit;\n\t\tthis.__sort;\n\t\tthis.__skip;\n\t\tthis.__next;\n\t\tthis.__pref;\n\t\tthis._findType;\n\n\t\tthis.schema = this.__Model.schema();\n\t}\n\n\tstatic castSortValue(value) {\n\t\tvar _v = parseInt(value, 10);\n\n\t\treturn (_v !== 1 && _v !== -1) ? 1 : _v;\n\t}\n\n\tstatic castSchemaValue(type, value) {\n\t\tswitch (type) {\n\t\t\tcase 'string':\n\t\t\t\treturn String(value);\n\t\t\tcase 'number':\n\t\t\t\treturn Number(value);\n\t\t\tcase 'date-time':\n\t\t\t\treturn new Date(value) || null;\n\t\t\tcase 'object':\n\t\t\t\treturn key.toLowerCase().match(/id$/) ? (this.__Model.db.ObjectId(value) || null) : value; // TODO: check in schema\n\t\t\tdefault:\n\t\t\t\treturn String(value);\n\t\t}\n\t}\n\n\tselect(select = {}) {\n\t\tthis.__select = select;\n\t}\n\n\tsort(sort = {}) {\n\t\tthis.__sort = sort;\n\n\t\treturn this;\n\t}\n\n\tlimit(limit) {\n\t\tthis.__limit = Math.abs(limit);\n\n\t\treturn this;\n\t}\n\n\tskip(skip) {\n\t\tthis.__skip = Math.abs(skip);\n\n\t\treturn this;\n\t}\n\n\tnext(id) {\n\t\tthis.__next = new ObjectId(id);\n\t}\n\n\tprev(id) {\n\t\tthis.__prev = new ObjectId(id);\n\t}\n\n\tbindCriteria(criteria = {}) {\n\t\tcriteria.limit && ( this.__criteria.limit = Math.abs(criteria.limit) );\n\t\tcriteria.next && ( this.__criteria.next = criteria.next );\n\t\tcriteria.prev && ( this.__criteria.prev = criteria.prev );\n\n\t\tif (criteria.filter) {\n\t\t\tif (!_.isObject(criteria.filter)) {\n\t\t\t\tthis.__criteria.filter = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.filter = criteria.filter;\n\n\t\t\tObject.keys(this.__criteria.filter).forEach((key) => {\n\t\t\t\tif (!this.__query.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.__query[key] = QueryResolver.castSchemaValue(this.schema.properties[key].type, this.__criteria.filter[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (criteria.limit && typeof this.__limit === 'undefined') {\n\t\t\tthis.limit(criteria.limit);\n\t\t}\n\n\t\tif (criteria.skip && typeof this.__skip === 'undefined') {\n\t\t\tthis.skip(criteria.skip);\n\t\t}\n\n\t\tif (criteria.sort) {\n\t\t\tif (!_.isObject(criteria.sort)) {\n\t\t\t\tcriteria.sort = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.sort = criteria.sort;\n\n\t\t\tObject.keys(this.__criteria.sort).forEach((key) => {\n\t\t\t\tif (!this.sort.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.sort[key] = QueryResolver.castSortValue(this.__criteria.sort[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tmerge(query = {}) {\n\t\tthis.__query = extend(this.__query, query);\n\n\t\treturn this;\n\t}\n\n\tfind(query = {}, select = {}, options = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'find';\n\n\t\treturn this;\n\t}\n\n\tfindOne(query = {}, select = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'findOne';\n\n\t\treturn this;\n\t}\n\n\texec(options = {}) {\n\t\tlet castResult = (res) => {\n\t\t\treturn options.lean ? res : (res && this.__Model.fill(res));\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet cursor = this.__Model.db.connect.collection(this.__Model.collection());\n\n\t\t\tswitch (this._findType) {\n\t\t\t\tcase 'find':\n\t\t\t\t\tif (this.__next || this.__prev) {\n\t\t\t\t\t\tif (!this.__query.$and) {\n\t\t\t\t\t\t\tthis.__query.$and = [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.__next && this.__query.$and.push({ _id: { $gt: this.__next } });\n\t\t\t\t\t\tthis.__prev && this.__query.$and.push({ _id: { $lt: this.__prev } });\n\t\t\t\t\t}\n\n\t\t\t\t\tcursor = cursor.find(this.__query);\n\n\t\t\t\t\tthis.__sort && cursor.sort(this.__sort);\n\t\t\t\t\tthis.__skip && cursor.skip(this.__skip);\n\t\t\t\t\tthis.__limit && cursor.limit(this.__limit);\n\n\t\t\t\t\tcursor.toArray((err, result) => {\n\t\t\t\t\t\treturn err ? reject(err) : resolve(result.map(castResult));\n\t\t\t\t\t});\n\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'findOne':\n\t\t\t\t\tcursor.findOne(this.__query, (err, result) => {\n\t\t\t\t\t\treturn err ? reject(err) : resolve(castResult(result));\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error('exec unknown findType')\n\t\t\t}\n\t\t})\n\t}\n}\n\nexport default QueryResolver;"]}