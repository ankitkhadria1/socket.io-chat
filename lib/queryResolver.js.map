{"version":3,"sources":["../src/queryResolver.es6"],"names":[],"mappings":"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","file":"queryResolver.js","sourcesContent":["import extend    from 'extend';\nimport debugBase from 'debug';\nimport _         from 'underscore';\n\nclass QueryResolver {\n\tconstructor(Model) {\n\t\tthis.__Model = Model;\n\n\t\tthis.__query    = {};\n\t\tthis.__criteria = {};\n\t\tthis.__select   = {};\n\t\tthis.__limit;\n\t\tthis.__sort;\n\t\tthis.__skip;\n\t\tthis.__next;\n\t\tthis.__pref;\n\t\tthis._findType;\n\n\t\tthis.schema = this.__Model.schema();\n\t}\n\n\tstatic castSortValue(value) {\n\t\tvar _v = parseInt(value, 10);\n\n\t\treturn (_v !== 1 && _v !== -1) ? 1 : _v;\n\t}\n\n\tstatic castSchemaValue(type, value) {\n\t\tswitch (type) {\n\t\t\tcase 'string':\n\t\t\t\treturn String(value);\n\t\t\tcase 'number':\n\t\t\t\treturn Number(value);\n\t\t\tcase 'date-time':\n\t\t\t\treturn new Date(value) || null;\n\t\t\tcase 'object':\n\t\t\t\treturn value.toLowerCase().match(/id$/) ? (this.__Model.db.ObjectId(value) || null) : value; // TODO: check in schema\n\t\t\tdefault:\n\t\t\t\treturn String(value);\n\t\t}\n\t}\n\n\tselect(select = {}) {\n\t\tthis.__select = select;\n\t}\n\n\tsort(sort = {}) {\n\t\tthis.__sort = sort;\n\n\t\treturn this;\n\t}\n\n\tlimit(limit) {\n\t\tthis.__limit = Math.abs(limit);\n\n\t\treturn this;\n\t}\n\n\tskip(skip) {\n\t\tthis.__skip = Math.abs(skip);\n\n\t\treturn this;\n\t}\n\n\tnext(id) {\n\t\tthis.__next = new ObjectId(id);\n\t}\n\n\tprev(id) {\n\t\tthis.__prev = new ObjectId(id);\n\t}\n\n\tbindCriteria(criteria = {}) {\n\t\tcriteria.limit && ( this.__criteria.limit = Math.abs(criteria.limit) );\n\t\tcriteria.next && ( this.__criteria.next = criteria.next );\n\t\tcriteria.prev && ( this.__criteria.prev = criteria.prev );\n\n\t\tif (criteria.filter) {\n\t\t\tif (!_.isObject(criteria.filter)) {\n\t\t\t\tthis.__criteria.filter = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.filter = criteria.filter;\n\n\t\t\tObject.keys(this.__criteria.filter).forEach((key) => {\n\t\t\t\tif (!this.__query.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.__query[key] = QueryResolver.castSchemaValue(this.schema.properties[key].type, this.__criteria.filter[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (criteria.limit && typeof this.__limit === 'undefined') {\n\t\t\tthis.limit(criteria.limit);\n\t\t}\n\n\t\tif (criteria.skip && typeof this.__skip === 'undefined') {\n\t\t\tthis.skip(criteria.skip);\n\t\t}\n\n\t\tif (criteria.sort) {\n\t\t\tif (!_.isObject(criteria.sort)) {\n\t\t\t\tcriteria.sort = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.sort = criteria.sort;\n\n\t\t\tObject.keys(this.__criteria.sort).forEach((key) => {\n\t\t\t\tif (!this.sort.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.sort[key] = QueryResolver.castSortValue(this.__criteria.sort[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tmerge(query = {}) {\n\t\tthis.__query = extend(this.__query, query);\n\n\t\treturn this;\n\t}\n\n\tfind(query = {}, select = {}, options = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'find';\n\n\t\treturn this;\n\t}\n\n\tfindOne(query = {}, select = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'findOne';\n\n\t\treturn this;\n\t}\n\n\texec(options = {}) {\n\n\t}\n}\n\nexport default QueryResolver;"]}