{"version":3,"sources":["../src/message.es6"],"names":[],"mappings":";;;;;;;;;;;;AAAA,AAAC,CAAA,YAAY;AACZ,aAAY,CAAC;;AAEb,KAAI,CAAC,GAAc,OAAO,CAAC,YAAY,CAAC;KACpC,IAAI,GAAW,OAAO,CAAC,MAAM,CAAC;KAC9B,EAAE,GAAa,OAAO,CAAC,MAAM,CAAC;KAC9B,KAAK,GAAU,OAAO,CAAC,SAAS,CAAC;KACjC,YAAY,GAAG,OAAO,CAAC,UAAU,CAAC;KAClC,KAAK,GAAU,OAAO,CAAC,SAAS,CAAC;KAEjC,YAAY,GAAG,IAAI,YAAY,EAAE;KACjC,MAAM,GAAS,YAAY,CAAC,IAAI,CAAC,SAAS,GAAG,yBAAyB,CAAC,CAAC;;AAE5E,OAAM,CAAC,OAAO,GAAG,UAAU,OAAO,EAAE;AACnC,MAAI,cAAc,CAAC;;AAEnB,gBAAc,GAAG,OAAO,CAAC,UAAU,IAAI,gBAAgB,CAAC;;MAElD,OAAO;AAyBD,YAzBN,OAAO,CAyBA,KAAK,EAAE;0BAzBd,OAAO;;AA0BX,+BA1BI,OAAO,6CA0BL,KAAK,EAAE;AACb,QAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;;AAEvB,QAAI,CAAC,EAAE,CAAC,gBAAgB,EAAE,YAAY;AACrC,SAAI,CAAC,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;AAC3B,UAAI,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,IAAI,EAAE,CAAC,CAAC;MAClC;KACD,CAAC,CAAC;IACH;;aAlCI,OAAO;;gBAAP,OAAO;;WACJ,oBAAG;AACV,YAAO;AACN,SAAG,EAAU,IAAI;AACjB,YAAM,EAAO,IAAI;AACjB,UAAI,EAAS,EAAE;AACf,eAAS,EAAI,IAAI;AACjB,cAAQ,EAAK,IAAI;AACjB,eAAS,EAAI,EAAE;AACf,iBAAW,EAAE,EAAE;AACf,UAAI,EAAS,MAAM;AACnB,YAAM,EAAO,EAAE;MACf,CAAC;KACF;;;WAuBQ,mBAAC,EAAE,EAAE;AACb,SAAI,EAAE,IAAI,EAAE,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;AAClC,UAAI,CAAC,GAAG,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;MACzB;KACD;;;WAEc,2BAAG;AACjB,SAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,0BAA0B,CAAC,CAAC,CAAC;KAC5D;;;WAEM,iBAAC,IAAI,EAAE;AACb,SAAI,IAAI,EAAE;AACT,UAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC;MACpC;KACD;;;WAEW,sBAAC,GAAG,EAAE;AACjB,SAAI,WAAW,CAAC;;AAEhB,SAAI,GAAG,EAAE;AACR,iBAAW,GAAG,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,EAAE;AACtC,cAAO,EAAE,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;OAC/B,CAAC,CAAC;;AAEH,UAAI,CAAC,GAAG,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;MACnC;KACD;;;WAEQ,mBAAC,IAAI,EAAE;AACf,SAAI,CAAC,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;AAC3B,SAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;KACzB;;;WAES,sBAAG;AACZ,YAAO,cAAc,CAAC;KACtB;;;WAxDY,kBAAoC;SAAnC,QAAQ,gCAAG,EAAE;SAAE,aAAa,gCAAG,EAAE;;AAC9C,SAAI,MAAM,CAAC;;AAEX,WAAM,GAAG,EAAE,CAAC,OAAO,EAAE,CAAC,UAAU,CAAC,cAAc,CAAC,CAC9C,IAAI,CAAC,QAAQ,CAAC,CACd,MAAM,CAAC,aAAa,CAAC,CAAC;;AAExB,YAAO,MAAM,CAAC;KACd;;;WAkDc,kBAAC,UAAU,EAAE,IAAI,EAAE,KAAK,EAAyB;SAAvB,IAAI,gCAAG,KAAK,CAAC,QAAQ;;AAC7D,SAAI,MAAM,GAAG,EAAE,CAAC,QAAQ,CAAC,UAAU,CAAC;SAChC,MAAM,GAAG,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC;SAC1B,KAAK,GAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,GAAG,EAAE,GAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,AAAC;SAC5D,KAAK,GAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC;;AAEhC,aAAQ,IAAI;AACX,WAAK,KAAK,CAAC,MAAM;AAChB,YAAK,CAAC,QAAQ,GAAG,MAAM,CAAC;AACxB,aAAM;AAAA,AACP,WAAK,KAAK,CAAC,QAAQ;AAClB,YAAK,CAAC,SAAS,GAAG,MAAM,CAAC;AACzB,aAAM;AAAA,MACP;;AAED,YAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM,EAAK;AACvC,QAAE,CAAC,UAAU,CAAC,UAAU,OAAO,EAAE;AAChC,cAAO,CAAC,UAAU,CAAC,cAAc,CAAC,CAChC,IAAI,CAAC,KAAK,CAAC,CACX,KAAK,CAAC,KAAK,CAAC,CACZ,OAAO,CAAC,UAAU,KAAK,EAAE,MAAM,EAAE;AACjC,YAAI,KAAK,EAAE;AACV,gBAAO,MAAM,CAAC,KAAK,CAAC,CAAC;SACrB;;AAED,eAAO,CAAC,MAAM,CAAC,CAAC;QAChB,CAAC,CAAA;OACH,CAAC,CAAC;MACH,CAAC,CAAC;KACH;;;WAEc,kBAAC,UAAU,EAAE,aAAa,EAAE,IAAI,EAAE,KAAK,EAAyB;SAAvB,IAAI,gCAAG,KAAK,CAAC,QAAQ;;AAC5E,SAAI,MAAM,GAAM,EAAE,CAAC,QAAQ,CAAC,UAAU,CAAC;SACnC,SAAS,GAAG,EAAE,CAAC,QAAQ,CAAC,aAAa,CAAC;SACtC,MAAM,GAAM,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC;SAC7B,KAAK,GAAO,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,GAAG,EAAE,GAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,AAAC;SAC/D,KAAK,GAAO,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,SAAS,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,MAAM,EAAE,CAAC;;AAE/E,aAAQ,IAAI;AACX,WAAK,KAAK,CAAC,MAAM;AAChB,YAAK,CAAC,QAAQ,GAAG,MAAM,CAAC;AACxB,aAAM;AAAA,AACP,WAAK,KAAK,CAAC,QAAQ;AAClB,YAAK,CAAC,SAAS,GAAG,MAAM,CAAC;AACzB,aAAM;AAAA,MACP;;AAED,YAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM,EAAK;AACvC,QAAE,CAAC,UAAU,CAAC,UAAU,OAAO,EAAE;AAChC,cAAO,CAAC,UAAU,CAAC,cAAc,CAAC,CAChC,IAAI,CAAC,KAAK,CAAC,CACX,KAAK,CAAC,KAAK,CAAC,CACZ,OAAO,CAAC,UAAU,KAAK,EAAE,MAAM,EAAE;AACjC,YAAI,KAAK,EAAE;AACV,gBAAO,MAAM,CAAC,KAAK,CAAC,CAAC;SACrB;;AAED,eAAO,CAAC,MAAM,CAAC,CAAC;QAChB,CAAC,CAAA;OACH,CAAC,CAAC;MACH,CAAC,CAAC;KACH;;;WAEY,gBAAC,UAAU,EAAE,aAAa,EAAE,IAAI,EAAE,KAAK,EAAyB;SAAvB,IAAI,gCAAG,KAAK,CAAC,QAAQ;;AAC1E,SAAI,MAAM,GAAM,EAAE,CAAC,QAAQ,CAAC,UAAU,CAAC;SACnC,SAAS,GAAG,EAAE,CAAC,QAAQ,CAAC,aAAa,CAAC;SACtC,MAAM,GAAM,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC;SAC7B,KAAK,GAAO,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,GAAG,EAAE,GAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,AAAC;SAC/D,KAAK,GAAO,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,SAAS,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC;;AAE5D,aAAQ,IAAI;AACX,WAAK,KAAK,CAAC,MAAM;AAChB,YAAK,CAAC,QAAQ,GAAG,MAAM,CAAC;AACxB,aAAM;AAAA,AACP,WAAK,KAAK,CAAC,QAAQ;AAClB,YAAK,CAAC,SAAS,GAAG,MAAM,CAAC;AACzB,aAAM;AAAA,MACP;;AAED,YAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM,EAAK;AACvC,QAAE,CAAC,UAAU,CAAC,UAAU,OAAO,EAAE;AAChC,cAAO,CAAC,UAAU,CAAC,cAAc,CAAC,CAChC,IAAI,CAAC,KAAK,CAAC,CACX,KAAK,CAAC,KAAK,CAAC,CACZ,OAAO,CAAC,UAAU,KAAK,EAAE,MAAM,EAAE;AACjC,YAAI,KAAK,EAAE;AACV,gBAAO,MAAM,CAAC,KAAK,CAAC,CAAC;SACrB;;AAED,eAAO,CAAC,MAAM,CAAC,CAAC;QAChB,CAAC,CAAA;OACH,CAAC,CAAC;MACH,CAAC,CAAC;KACH;;;UAtKI,OAAO;KAAS,KAAK;;AA0K3B,SAAO,OAAO,CAAC;EACf,CAAC;CACF,CAAA,EAAE,CAAE","file":"src/message.es6","sourcesContent":["(function () {\n\t\"use strict\";\n\n\tvar _            = require('underscore'),\n\t    util         = require('util'),\n\t    db           = require('./db'),\n\t    Model        = require('./model'),\n\t    SchemaLoader = require('./schema'),\n\t    FLAGS        = require('./flags'),\n\n\t    schemaLoader = new SchemaLoader(),\n\t    schema       = schemaLoader.load(__dirname + '/../schema/message.json');\n\n\tmodule.exports = function (options) {\n\t\tvar collectionName;\n\n\t\tcollectionName = options.collection || 'chats_messages';\n\n\t\tclass Message extends Model {\n\t\t\tdefaults() {\n\t\t\t\treturn {\n\t\t\t\t\t_id:         null,\n\t\t\t\t\tchatId:      null,\n\t\t\t\t\ttext:        '',\n\t\t\t\t\tcreatedAt:   null,\n\t\t\t\t\tauthorId:    null,\n\t\t\t\t\treceivers:   [],\n\t\t\t\t\tattachments: [],\n\t\t\t\t\ttype:        'user',\n\t\t\t\t\tsystem:      {}\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tstatic stream(criteria = {}, streamOptions = {}) {\n\t\t\t\tvar cursor;\n\n\t\t\t\tcursor = db.connect().collection(collectionName)\n\t\t\t\t\t.find(criteria)\n\t\t\t\t\t.stream(streamOptions);\n\n\t\t\t\treturn cursor;\n\t\t\t}\n\n\t\t\tconstructor(props) {\n\t\t\t\tsuper(props);\n\t\t\t\tthis.setSchema(schema);\n\n\t\t\t\tthis.on('beforeValidate', function () {\n\t\t\t\t\tif (!this.get('createdAt')) {\n\t\t\t\t\t\tthis.set('createdAt', new Date());\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tsetAuthor(id) {\n\t\t\t\tif (id && db.ObjectID.isValid(id)) {\n\t\t\t\t\tthis.set('authorId', id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetSystemAuthor() {\n\t\t\t\tthis.setAuthor(new db.ObjectID(\"000000000000000000000000\"));\n\t\t\t}\n\n\t\t\tsetChat(chat) {\n\t\t\t\tif (chat) {\n\t\t\t\t\tthis.set('chatId', chat.get('_id'));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetReceivers(ids) {\n\t\t\t\tvar filteredIds;\n\n\t\t\t\tif (ids) {\n\t\t\t\t\tfilteredIds = ids.filter(function (id) {\n\t\t\t\t\t\treturn db.ObjectID.isValid(id);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.set('receivers', filteredIds);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetSystem(data) {\n\t\t\t\tthis.set('type', 'system');\n\t\t\t\tthis.set('system', data);\n\t\t\t}\n\n\t\t\tcollection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tstatic findLast(dataChatId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\t\tvar chatId = db.ObjectId(dataChatId),\n\t\t\t\t    userId = db.ObjectId(user),\n\t\t\t\t    limit  = Math.abs(count) > 50 ? 50 : (Math.abs(count) || 10),\n\t\t\t\t    query  = { chatId: chatId };\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName)\n\t\t\t\t\t\t\t.find(query)\n\t\t\t\t\t\t\t.limit(limit)\n\t\t\t\t\t\t\t.toArray(function (error, result) {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findFrom(dataChatId, dataMessageId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\t\tvar chatId    = db.ObjectId(dataChatId),\n\t\t\t\t    messageId = db.ObjectId(dataMessageId),\n\t\t\t\t    userId    = db.ObjectId(user),\n\t\t\t\t    limit     = Math.abs(count) > 50 ? 50 : (Math.abs(count) || 10),\n\t\t\t\t    query     = { _id: { $gt: messageId }, chatId: chatId, receivers: userId };\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName)\n\t\t\t\t\t\t\t.find(query)\n\t\t\t\t\t\t\t.limit(limit)\n\t\t\t\t\t\t\t.toArray(function (error, result) {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findAt(dataChatId, dataMessageId, user, count, flag = FLAGS.RECEIVER) {\n\t\t\t\tvar chatId    = db.ObjectId(dataChatId),\n\t\t\t\t    messageId = db.ObjectId(dataMessageId),\n\t\t\t\t    userId    = db.ObjectId(user),\n\t\t\t\t    limit     = Math.abs(count) > 50 ? 50 : (Math.abs(count) || 10),\n\t\t\t\t    query     = { _id: { $lt: messageId }, chatId: chatId };\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName)\n\t\t\t\t\t\t\t.find(query)\n\t\t\t\t\t\t\t.limit(limit)\n\t\t\t\t\t\t\t.toArray(function (error, result) {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t}\n\n\t\treturn Message;\n\t};\n}());"]}