{"version":3,"sources":["../../src/model/model.es6"],"names":[],"mappings":"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","file":"model.js","sourcesContent":["import _ \t\t\t from 'underscore';\nimport { debug }     from '../debug';\nimport clone         from 'clone';\nimport deepExtend    from 'deep-extend';\nimport QueryResolver from '../queryResolver';\nimport SchemaLoader  from '../schema';\n\nimport MArray from './array';\n\nvar typeOf = function (object) {\n\treturn Object.prototype.toString.call(object).replace(/\\[object\\s(\\w+)\\]/, '$1');\n};\n\nexport default class Model {\n\tconstructor() {\n\t\tthis.isNew = true;\n\t\tthis._atomics = {};\n\t}\n\n\tinitialize(options = {}) {\n\t\tthis.defaults = this.schema();\n\t\tthis.readOnly = this.schema();\n\n\t\tthis.set(this.defaults);\n\n\t\tconsole.log(this.defaults);\n\t}\n\n\tstatic ensureIndex() {\n\t\tSchemaLoader\n\t\t\t.index(this.schema())\n\t\t\t.forEach(function (value, index) {\n\t\t\t\tthis.db().connect.collection(this.collection()).ensureIndex(index, value, function (err, result) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tdebug('ensure index: ' + err.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t}\n\n\tset defaults(schema) {\n\t\tthis._defaults = SchemaLoader.defaults(schema);\n\t}\n\n\tget defaults() {\n\t\treturn clone(this._defaults);\n\t}\n\n\tset readOnly(schema) {\n\t\tthis._readOnly = SchemaLoader.readOnly(schema);\n\t}\n\n\tget readOnly() {\n\t\treturn this._readOnly;\n\t}\n\n\tset(key, value, path = []) {\n\t\tif (arguments.length === 1) {\n\t\t\t_.each(key, (value, key) => {\n\t\t\t\tthis.set(key, value, path.push(key));\n\t\t\t});\n\t\t} else {\n\t\t\tpath = [key];\n\t\t}\n\n\t\tif (this.defaults.hasOwnProperty(key) && !~this.readOnly.indexOf(path.join('.'))) {\n\t\t\tthis[key] = value;\n\n\t\t\tif (~['Number', 'String', 'Data', 'Boolean', 'Object', 'Null'].indexOf(typeOf(value))) {\n\t\t\t\tthis.addAtomic('set', key, value);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tget(key) {\n\t\tif (~this.defaults.indexOf(key)) {\n\t\t\treturn this[key];\n\t\t}\n\t}\n\n\tfill(key, value, isAtomic = false) {\n\t\tif (_.isBoolean(arguments[1])) {\n\t\t\t_.each(key, (value, key1) => {\n\t\t\t\tthis.fill(key1, value);\n\t\t\t});\n\t\t}\n\n\t\tif (this.defaults.hasOwnProperty(key)) {\n\t\t\tswitch (typeOf(value)) {\n\t\t\t\tcase 'Array':\n\t\t\t\t\tthis[key]       = new MArray();\n\t\t\t\t\tthis[key].model = this;\n\t\t\t\t\tthis[key].path  = key; // TODO: path with dot\n\t\t\t\t\tthis[key].push(...value);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthis[key] = value;\n\t\t\t}\n\n\t\t\tif (isAtomic) {\n\t\t\t\tthis.addAtomic('set', key, value);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\ttoJSON() {\n\t\tlet output = {};\n\n\t\tfor (let prop in this) {\n\t\t\tif (this.hasOwnProperty(prop)) {\n\t\t\t\toutput[prop] = this[prop];\n\t\t\t}\n\t\t}\n\n\t\treturn clone(output, true);\n\t}\n\n\taddAtomic(type, key, value) {\n\t\tif (this.isNew) {\n\t\t\t// TODO: if type is addToSet/push, this override initialized values\n\t\t\tdeepExtend(this._atomics, { '$set': { [key]: value } });\n\t\t\treturn this;\n\t\t}\n\n\t\tswitch (type) {\n\t\t\tcase 'set':\n\t\t\tcase 'pull':\n\t\t\tcase 'pullAll':\n\t\t\tcase 'pop':\n\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: value } });\n\t\t\t\tbreak;\n\n\t\t\tcase 'push':\n\t\t\tcase 'addToSet':\n\t\t\t\tswitch (typeOf(value)) {\n\t\t\t\t\tcase 'Array':\n\t\t\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: { $each: value } } });\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: value } });\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tstatic find() {\n\t\tlet queryResolver = new QueryResolver(Model);\n\n\t\treturn queryResolver.find.apply(queryResolver, arguments);\n\t}\n\n\tstatic findOne() {\n\t\tlet queryResolver = new QueryResolver(Model);\n\n\t\treturn queryResolver.findOne.apply(queryResolver, arguments);\n\t}\n}"]}