{"version":3,"sources":["../../src/model/model.es6"],"names":[],"mappings":"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","file":"model.js","sourcesContent":["import _                from 'underscore';\nimport { debug }        from '../debug';\nimport clone            from 'clone';\nimport deepExtend       from 'deep-extend';\nimport QueryResolver    from '../queryResolver';\nimport SchemaLoader     from '../schema';\nimport { Validator }    from 'jsonschema';\nimport { EventEmitter } from 'events';\nimport MArray           from './array';\n\nconst ERROR_VALIDATION_TYPE = 'validation';\n\nvar typeOf = function (object) {\n\treturn Object.prototype.toString.call(object).replace(/\\[object\\s(\\w+)\\]/, '$1');\n};\n\nexport default class Model extends EventEmitter {\n\tconstructor(data = {}) {\n\t\tsuper();\n\n\t\tObject.defineProperties(this, {\n\t\t\tisNew:      { value: true, writable: true, enumerable: false },\n\t\t\t_atomics:   { value: {}, writable: true, enumerable: false },\n\t\t\t_defaults:  { value: {}, writable: true, enumerable: false },\n\t\t\t_readOnly:  { value: [], writable: true, enumerable: false },\n\t\t\t_propPaths: { value: [], writable: true, enumerable: false },\n\t\t\t_data:      { value: data, writable: true, enumerable: false },\n\t\t\terrors:     { value: [], writable: true, enumerable: false },\n\t\t\terror:      { value: null, writable: true, enumerable: false }\n\t\t});\n\t}\n\n\tinitialize(options = {}) {\n\t\tthis.defaults  = this.constructor.schema();\n\t\tthis.readOnly  = this.constructor.schema();\n\t\tthis.propPaths = this.constructor.schema();\n\n\t\tthis.set(this.defaults);\n\t\tthis.set(this._data);\n\n\t\tthis._data = {};\n\t}\n\n\tset defaults(schema) {\n\t\tthis._defaults = SchemaLoader.defaults(schema);\n\t}\n\n\tget defaults() {\n\t\treturn clone(this._defaults);\n\t}\n\n\tset readOnly(schema) {\n\t\tthis._readOnly = SchemaLoader.readOnly(schema);\n\t}\n\n\tget readOnly() {\n\t\treturn this._readOnly;\n\t}\n\n\tset propPaths(schema) {\n\t\tthis._propPaths = SchemaLoader.propPaths(schema);\n\t}\n\n\tget propPaths() {\n\t\treturn this._propPaths;\n\t}\n\n\tset(values, value = undefined, path = []) {\n\t\tif (arguments.length !== 1) {\n\t\t\tvalues = { [values]: value }\n\t\t}\n\n\t\tif (typeOf(values) === 'Object') {\n\n\t\t\tfor (let prop in values) {\n\t\t\t\tif (values.hasOwnProperty(prop)) {\n\t\t\t\t\tthis[prop] = this.castData(values[prop]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tget(key) {\n\t\tif (~this.defaults.hasOwnProperty(key)) {\n\t\t\treturn this[key];\n\t\t}\n\t}\n\n\tfill(key, value, isAtomic = false) {\n\t\tif (_.isBoolean(arguments[1])) {\n\t\t\t_.each(key, (value, key1) => {\n\t\t\t\tthis.fill(key1, value);\n\t\t\t});\n\t\t}\n\n\t\tthis.createProperty(key, value);\n\n\t\treturn this;\n\t}\n\n\tcreateProperty(key, value) {\n\t\tif (this.defaults.hasOwnProperty(key)) {\n\t\t\tswitch (typeOf(value)) {\n\t\t\t\tcase 'Array':\n\t\t\t\t\tthis[key]       = new MArray();\n\t\t\t\t\tthis[key].model = this;\n\t\t\t\t\tthis[key].path  = key; // TODO: path with dot\n\t\t\t\t\tthis[key].push(...value);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthis[key] = value;\n\t\t\t}\n\n\t\t\tif (isAtomic) {\n\t\t\t\tthis.addAtomic('set', key, value);\n\t\t\t}\n\t\t}\n\t}\n\n\ttoJSON() {\n\t\tlet output   = {};\n\t\tlet defaults = this.defaults;\n\n\t\tlet walker = function (obj, output) {\n\t\t\tfor (let prop in obj) {\n\t\t\t\tif (obj.hasOwnProperty(prop) && defaults.hasOwnProperty) {\n\t\t\t\t\tif (obj[prop] instanceof MArray) {\n\t\t\t\t\t\toutput[prop] = [];\n\t\t\t\t\t\twalker(obj[prop], output[prop]);\n\t\t\t\t\t\t//obj[prop].forEach(function (value) {\n\t\t\t\t\t\t//\twalker(value, output[prop]);\n\t\t\t\t\t\t//});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tswitch (typeOf(obj[prop])) {\n\t\t\t\t\t\t\tcase 'Object':\n\t\t\t\t\t\t\t\toutput[prop] = {};\n\t\t\t\t\t\t\t\twalker(obj[prop], output[prop]);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'Array':\n\t\t\t\t\t\t\t\toutput[prop] = [];\n\t\t\t\t\t\t\t\tobj[prop].forEach(function (value) {\n\t\t\t\t\t\t\t\t\twalker(value, output[prop]);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\toutput[prop] = obj[prop];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\twalker(this, output);\n\n\t\treturn output;\n\t}\n\n\taddAtomic(type, key, value) {\n\t\tif (this.isNew) {\n\t\t\t// TODO: if type is addToSet/push, this override initialized values\n\t\t\tdeepExtend(this._atomics, { '$set': { [key]: value } });\n\t\t\treturn this;\n\t\t}\n\n\t\tswitch (type) {\n\t\t\tcase 'set':\n\t\t\tcase 'pull':\n\t\t\tcase 'pullAll':\n\t\t\tcase 'pop':\n\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: value } });\n\t\t\t\tbreak;\n\n\t\t\tcase 'push':\n\t\t\tcase 'addToSet':\n\t\t\t\tswitch (typeOf(value)) {\n\t\t\t\t\tcase 'Array':\n\t\t\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: { $each: value } } });\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tdeepExtend(this._atomics, { ['$' + type]: { [key]: value } });\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tsave() {\n\t\tlet promise = (resolve, reject) => {\n\t\t\tthis.isValid() ? resolve() : reject(this.error);\n\t\t};\n\n\t\treturn new Promise(promise)\n\t\t\t.then(() => {\n\t\t\t\tlet cursor = this.db().provider.collection(this);\n\n\t\t\t\tif (this.isNew) {\n\t\t\t\t\treturn cursor.insert(this.toJSON()).exec()\n\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\tthis.isNew = false;\n\t\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\treturn cursor.update(this.toJSON()).exec()\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tisValid() {\n\t\tvar result = false, error;\n\n\t\tresult = this.validate();\n\n\t\tif (result.length > 0) {\n\t\t\tresult.forEach(function (error) {\n\t\t\t\terror.type = ERROR_VALIDATION_TYPE;\n\t\t\t});\n\n\t\t\tthis.errors = result;\n\t\t\tthis.error  = this.errors[0];\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tvalidate() {\n\t\tvar validator = new Validator(),\n\t\t\tresult    = validator.validate(this.toJSON(), this.schema());\n\n\t\tthis.emit('beforeValidate');\n\n\t\tif (result.errors.length) {\n\t\t\treturn result.errors;\n\t\t}\n\n\t\tthis.emit('validate');\n\n\t\treturn [];\n\t}\n\n\tcastData(data, path = []) {\n\t\tswitch (typeOf(data)) {\n\t\t\tcase 'Object':\n\t\t\t\tfor (let prop in data) {\n\t\t\t\t\tif (data.hasOwnProperty(prop)) {\n\t\t\t\t\t\tthis.castData(data[prop], path.concat([prop]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'Array':\n\t\t\t\tlet newArray    = new MArray();\n\t\t\t\tnewArray._model = this;\n\t\t\t\tnewArray._path  = path.join('.');\n\t\t\t\tnewArray.push(...data);\n\t\t\t\tdata            = newArray;\n\t\t\t\tdata.forEach((value) => {\n\t\t\t\t\tthis.castData(value, path);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn data;\n\t}\n\n;\n\n\tstatic find(query, select) {\n\t\treturn this.db().provider.collection(this).find(query, select);\n\t}\n\n\tstatic findOne(query, select) {\n\t\treturn this.db().provider.collection(this).findOne(query, select);\n\t}\n\n\tstatic insert() {\n\n\t}\n\n\tstatic update() {\n\n\t}\n\n\tstatic remove() {\n\n\t}\n\n\tstatic ensureIndex(Model) {\n\t\tSchemaLoader\n\t\t\t.index(Model.schema())\n\t\t\t.forEach(function (value, index) {\n\t\t\t\t//Model.db().connect.collection(Model.collection()).ensureIndex(index, value, function (err, result) {\n\t\t\t\t//\tif (err) {\n\t\t\t\t//\t\tdebug('ensure index: ' + err.message);\n\t\t\t\t//\t}\n\t\t\t\t//});\n\t\t\t});\n\t}\n}"]}