{"version":3,"sources":["../../src/old/queryResolver.es6"],"names":[],"mappings":"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","file":"queryResolver.js","sourcesContent":["(function () {\n\t\"use strict\";\n\tvar extend = require('extend'),\n\t\tdb     = require('./db'),\n\t\tdebug  = require('debug')('develop'),\n\t\t_      = require('underscore');\n\n\tfunction castSortValue(value) {\n\t\tvar _v = parseInt(value, 10);\n\n\t\treturn (_v !== 1 && _v !== -1) ? 1 : _v;\n\t}\n\n\tclass QueryResolver {\n\t\tconstructor() {\n\t\t\tthis.query    = {};\n\t\t\tthis.select   = {};\n\t\t\tthis.sort     = {};\n\t\t\tthis.limit    = null;\n\t\t\tthis.schema   = {};\n\t\t\tthis.next     = null;\n\t\t\tthis.prev     = null;\n\t\t\tthis.criteria = {};\n\t\t}\n\n\t\tcollection(collection) {\n\t\t\tthis.collection = collection;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetQuery(query) {\n\t\t\tthis.query = query;\n\n\t\t\treturn this;\n\t\t}\n\n\t\taddQuery(query) {\n\t\t\textend(this.query, query);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetLimit(limit = null) {\n\t\t\tif (limit) {\n\t\t\t\tthis.limit = Math.abs(limit) > 50 ? 50 : (Math.abs(limit) || 10);\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSort(sort) {\n\t\t\tthis.sort = sort;\n\n\t\t\treturn this;\n\t\t}\n\n\t\taddSort(sort) {\n\t\t\textend(this.sort, sort);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSelect(select) {\n\t\t\tthis.select = select;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSchema(schema) {\n\t\t\tthis.schema = schema;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetNext() {\n\t\t\tthis.next = db.ObjectId(this.criteria.next);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetPrev() {\n\t\t\tthis.prev = db.ObjectId(this.criteria.prev);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tbindCriteria(criteria = {}) {\n\t\t\tthis.criteria = criteria;\n\n\t\t\tthis.criteria.limit && this.setLimit(this.criteria.limit);\n\t\t\tthis.criteria.next && this.setNext(this.criteria.next);\n\t\t\tthis.criteria.prev && this.setPrev(this.criteria.prev);\n\n\t\t\tif (this.criteria.filter) {\n\t\t\t\tif (!_.isObject(this.criteria.filter)) {\n\t\t\t\t\tthis.criteria.filter = {};\n\t\t\t\t}\n\n\t\t\t\tObject.keys(this.criteria.filter).forEach((key) => {\n\t\t\t\t\tif (!this.query.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\t\tswitch (this.schema.properties[key].type) {\n\t\t\t\t\t\t\tcase 'string':\n\t\t\t\t\t\t\t\tthis.query[key] = String(this.criteria.filter[key]);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'number':\n\t\t\t\t\t\t\t\tthis.query[key] = Number(this.criteria.filter[key]);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'date-time':\n\t\t\t\t\t\t\t\tthis.query[key] = new Date(this.criteria.filter[key]) || null;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'object':\n\t\t\t\t\t\t\t\tif (key.toLowerCase().match(/id$/)) {\n\t\t\t\t\t\t\t\t\tthis.query[key] = db.ObjectId(this.criteria.filter[key]) || null;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tthis.query[key] = String(this.criteria.filter[key]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (this.criteria.sort) {\n\t\t\t\tif (!_.isObject(this.criteria.sort)) {\n\t\t\t\t\tthis.criteria.sort = {};\n\t\t\t\t}\n\n\t\t\t\tObject.keys(this.criteria.sort).forEach((key) => {\n\t\t\t\t\tif (!this.sort.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\t\tthis.sort[key] = castSortValue(this.criteria.sort[key]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tfind() {\n\t\t\tvar cursor,\n\t\t\t\tcollectionName = this.collection,\n\t\t\t\tquery          = this.query,\n\t\t\t\tselect         = this.select,\n\t\t\t\tlimit          = this.limit,\n\t\t\t\tsort           = this.sort,\n\t\t\t\tnext           = this.next,\n\t\t\t\tprev           = this.prev;\n\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tif (next || prev) {\n\t\t\t\t\t\tif (!query.$and) {\n\t\t\t\t\t\t\tquery.$and = [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnext && query.$and.push({ _id: { $gt: next } });\n\t\t\t\t\t\tprev && query.$and.push({ _id: { $lt: prev } });\n\t\t\t\t\t}\n\n\t\t\t\t\tcursor = connect.collection(collectionName).find(query, select);\n\n\t\t\t\t\tif (Object.keys(sort).length > 0) cursor.sort(sort);\n\t\t\t\t\tif (isFinite(limit)) cursor.limit(limit);\n\n\t\t\t\t\tcursor.toArray(function (err, res) {\n\t\t\t\t\t\terr ? reject(err) : resolve(res);\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tfindOne() {\n\t\t\tvar cursor,\n\t\t\t\tcollectionName = this.collection,\n\t\t\t\tquery          = this.query,\n\t\t\t\tselect         = this.select;\n\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tcursor = connect.collection(collectionName);\n\t\t\t\t\tcursor.findOne(query, function (err, res) {\n\t\t\t\t\t\terr ? reject(err) : resolve(res);\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tmodule.exports = QueryResolver;\n}());"]}