{"version":3,"sources":["../../src/old/queryResolver2.es6"],"names":[],"mappings":"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","file":"queryResolver2.js","sourcesContent":["import extend \t from 'extend';\nimport db \t\t from './db';\nimport debugBase from 'debug';\nimport _ \t\t from 'underscore';\n\nclass QueryResolver {\n\tconstructor(Model) {\n\t\tthis.__Model = Model;\n\n\t\tthis.__query = {};\n\t\tthis.__criteria = {};\n\t\tthis.__select = {};\n\t\tthis.__limit;\n\t\tthis.__sort;\n\t\tthis.__skip;\n\t\tthis.__next;\n\t\tthis.__pref;\n\t\tthis._findType;\n\n\t\tthis.schema = this.__Model.schema();\n\t}\n\n\tstatic castSortValue(value) {\n\t\tvar _v = parseInt(value, 10);\n\n\t\treturn (_v !== 1 && _v !== -1) ? 1 : _v;\n\t}\n\n\tstatic castSchemaValue(type, value) {\n\t\tswitch (type) {\n\t\t\tcase 'string':    return String(value);\n\t\t\tcase 'number':    return Number(value);\n\t\t\tcase 'date-time': return new Date(value) || null;\n\t\t\tcase 'object':    return key.toLowerCase().match(/id$/) ? (db.ObjectId(value) || null) : value; // TODO: check in schema\n\t\t\tdefault:          return String(value);\n\t\t}\n\t}\n\n\tselect (select = {}) {\n\t\tthis.__select = select;\n\t}\n\n\tsort (sort = {}) {\n\t\tthis.__sort = sort;\n\n\t\treturn this;\n\t}\n\n\tlimit (limit) {\n\t\tthis.__limit = Math.abs(limit);\n\n\t\treturn this;\n\t}\n\n\tskip (skip) {\n\t\tthis.__skip = Math.abs(skip);\n\n\t\treturn this;\n\t}\n\n\tnext(id) {\n\t\tthis.__next = new ObjectId(id);\n\t}\n\n\tprev(id) {\n\t\tthis.__prev = new ObjectId(id);\n\t}\n\n\tbindCriteria (criteria = {}) {\n\t\tcriteria.limit && ( this.__criteria.limit = Math.abs(criteria.limit) );\n\t\tcriteria.next  && ( this.__criteria.next = criteria.next );\n\t\tcriteria.prev  && ( this.__criteria.prev = criteria.prev );\n\n\t\tif (criteria.filter) {\n\t\t\tif (!_.isObject(criteria.filter)) {\n\t\t\t\tthis.__criteria.filter = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.filter = criteria.filter;\n\n\t\t\tObject.keys(this.__criteria.filter).forEach((key) => {\n\t\t\t\tif (!this.__query.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.__query[key] = QueryResolver.castSchemaValue(this.schema.properties[key].type, this.__criteria.filter[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (criteria.limit && typeof this.__limit === 'undefined') {\n\t\t\tthis.limit(criteria.limit);\n\t\t}\n\n\t\tif (criteria.skip && typeof this.__skip === 'undefined') {\n\t\t\tthis.skip(criteria.skip);\n\t\t}\n\n\t\tif (criteria.sort) {\n\t\t\tif (!_.isObject(criteria.sort)) {\n\t\t\t\tcriteria.sort = {};\n\t\t\t}\n\n\t\t\tthis.__criteria.sort = criteria.sort;\n\n\t\t\tObject.keys(this.__criteria.sort).forEach((key) => {\n\t\t\t\tif (!this.sort.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\tthis.sort[key] = QueryResolver.castSortValue(this.__criteria.sort[key]);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tmerge(query = {}) {\n\t\tthis.__query = extend(this.__query, query);\n\n\t\treturn this;\n\t}\n\n\tfind (query = {}, select = {}, options = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'find';\n\n\t\treturn this;\n\t}\n\n\tfindOne (query = {}, select = {}) {\n\t\tthis.__query = query;\n\t\tthis.select(select);\n\n\t\tthis._findType = 'findOne';\n\n\t\treturn this;\n\t}\n\n\texec (options = {}) {\n\t\tlet castResult = (res) => {\n\t\t\treturn options.lean ? res : (res && this.__Model.fill(res));\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tdb.getConnect((connect) => {\n\t\t\t\tlet cursor = connect.collection(this.__Model.collection());\n\n\t\t\t\tswitch (this._findType) {\n\t\t\t\t\tcase 'find': \n\t\t\t\t\t\tif (this.__next || this.__prev) {\n\t\t\t\t\t\t\tif (!this.__query.$and) {\n\t\t\t\t\t\t\t\tthis.__query.$and = [];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.__next && this.__query.$and.push({ _id: { $gt: this.__next } });\n\t\t\t\t\t\t\tthis.__prev && this.__query.$and.push({ _id: { $lt: this.__prev } });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t \tcursor = cursor.find(this.__query);\n\n\t\t\t\t\t\tthis.__sort && cursor.sort(this.__sort);\n\t\t\t\t\t\tthis.__skip && cursor.skip(this.__skip);\n\t\t\t\t\t\tthis.__limit && cursor.limit(this.__limit);\n\t\t\t\t\t\t\n\t\t\t\t\t\tcursor.toArray((err, result) => {\n\t\t\t\t\t\t\treturn err ? reject(err) : resolve(result.map(castResult));\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'findOne':\n\t\t\t\t\t\tcursor.findOne(this.__query, (err, result) => {\n\t\t\t\t\t\t\treturn err ? reject(err) : resolve(castResult(result));\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault: throw new Error('exec unknown findType')\n\t\t\t\t}\n\t\t\t});\n\t\t})\n\t}\n}\n\nexport default QueryResolver;"]}