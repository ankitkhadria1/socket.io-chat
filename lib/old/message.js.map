{"version":3,"sources":["../../src/old/message.es6"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["(function () {\n\t\"use strict\";\n\n\tvar _             = require('underscore'),\n\t\tutil          = require('util'),\n\t\tdb            = require('./db'),\n\t\tModel         = require('./model'),\n\t\tSchemaLoader  = require('./schema'),\n\t\tFLAGS         = require('./flags'),\n\t\textend        = require('extend'),\n\t\tQueryResolver = require('./queryResolver'),\n\n\t\tschemaLoader  = new SchemaLoader();\n\n\tmodule.exports = function (options) {\n\t\tvar collectionName = 'chats_messages',\n\t\t\tschema         = schemaLoader.load(__dirname + '/../schema/message.json');\n\n\t\toptions.collection && (collectionName = options.collection);\n\t\toptions.schema && (schema = extend(true, schema, options.schema));\n\n\t\tclass Message extends Model {\n\t\t\tdefaults() {\n\t\t\t\treturn schemaLoader.defaults(schema);\n\t\t\t}\n\n\t\t\tconstructor(props) {\n\t\t\t\tsuper(props);\n\n\t\t\t\tthis.setSchema(schema);\n\n\t\t\t\tthis.on('beforeValidate', function () {\n\t\t\t\t\tif (!this.get('createdAt')) {\n\t\t\t\t\t\tthis.set('createdAt', new Date());\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic stream(criteria = {}, streamOptions = {}) {\n\t\t\t\tvar cursor;\n\n\t\t\t\tcursor = db.connect().collection(collectionName)\n\t\t\t\t\t.find(criteria)\n\t\t\t\t\t.stream(streamOptions);\n\n\t\t\t\treturn cursor;\n\t\t\t}\n\n\t\t\tsetAuthor(id) {\n\t\t\t\tif (id && db.ObjectID.isValid(id)) {\n\t\t\t\t\tthis.set('authorId', id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetSystemAuthor() {\n\t\t\t\tthis.setAuthor(new db.ObjectID(\"000000000000000000000000\"));\n\t\t\t}\n\n\t\t\tsetChat(chat) {\n\t\t\t\tif (chat) {\n\t\t\t\t\tthis.set('chatId', chat.get('_id'));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetReceivers(ids) {\n\t\t\t\tvar filteredIds;\n\n\t\t\t\tif (ids) {\n\t\t\t\t\tfilteredIds = ids.filter(function (id) {\n\t\t\t\t\t\treturn db.ObjectID.isValid(id);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.set('receivers', filteredIds);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetSystem(data) {\n\t\t\t\tthis.set('type', 'system');\n\t\t\t\tthis.set('system', data);\n\t\t\t}\n\n\t\t\tsetReaded(user) {\n\t\t\t\tvar userId = new db.ObjectId(user);\n\n\t\t\t\tif (!userId) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!~this.receivers.map(String).indexOf(String(userId))) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this.read && this.read.map(String).indexOf(String(userId))) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!read) {\n\t\t\t\t\tthis.set('read', []);\n\t\t\t\t}\n\n\t\t\t\tthis.read.push(userId);\n\t\t\t}\n\n\t\t\taddAttachments(files = {}) {\n\t\t\t\t_.each(files, function (file) {\n\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tcollection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tstatic collection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tstatic schema() {\n\t\t\t\treturn schema;\n\t\t\t}\n\n\t\t\tstatic findLast(dataChatId, user, count, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\t\t\tvar chatId        = db.ObjectId(dataChatId),\n\t\t\t\t\tuserId        = db.ObjectId(user),\n\t\t\t\t\tquery         = { chatId: chatId },\n\t\t\t\t\tqueryResolver = new QueryResolver();\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.setSort({}, criteria.sort)\n\t\t\t\t\t.setLimit(criteria.limit || count)\n\t\t\t\t\t.setNext(criteria.next)\n\t\t\t\t\t.find();\n\t\t\t}\n\n\t\t\tstatic findFrom(dataChatId, dataMessageId, user, count, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\t\t\tvar queryResolver = new QueryResolver(),\n\t\t\t\t\tchatId        = db.ObjectId(dataChatId),\n\t\t\t\t\tmessageId     = db.ObjectId(dataMessageId),\n\t\t\t\t\tuserId        = db.ObjectId(user),\n\t\t\t\t\tquery         = { _id: { $gt: messageId }, chatId: chatId, receivers: userId };\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.setSort({}, criteria.sort)\n\t\t\t\t\t.setLimit(criteria.limit || count)\n\t\t\t\t\t.find();\n\t\t\t}\n\n\t\t\tstatic findAt(dataChatId, dataMessageId, user, count, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\t\t\tvar queryResolver = new QueryResolver(),\n\t\t\t\t\tchatId        = db.ObjectId(dataChatId),\n\t\t\t\t\tmessageId     = db.ObjectId(dataMessageId),\n\t\t\t\t\tuserId        = db.ObjectId(user),\n\t\t\t\t\tquery         = { _id: { $lt: messageId }, chatId: chatId };\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR:\n\t\t\t\t\t\tquery.authorId = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase FLAGS.RECEIVER:\n\t\t\t\t\t\tquery.receivers = userId;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.setSort({}, criteria.sort)\n\t\t\t\t\t.setLimit(criteria.limit || count)\n\t\t\t\t\t.find();\n\t\t\t}\n\n\t\t\tstatic findUnreaded(user, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\t\t\tvar userId = db.ObjectId(user),\n\t\t\t\t\tquery = {\n\t\t\t\t\t\tread: { $nin: [userId] }\n\t\t\t\t\t};\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR: query.authorId = userId; break;\n\t\t\t\t\tcase FLAGS.RECEIVER: query.receivers = userId; break;\n\t\t\t\t}\n\n\t\t\t\treturn Model\n\t\t\t\t\t.find(Message, query)\n\t\t\t\t\t.sort({ createdAt: -1 })\n\t\t\t\t\t.limit(20)\n\t\t\t\t\t.bindCriteria(criteria);\n\t\t\t}\n\n\t\t\tstatic findAllLast(user, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\t\t\tvar userId = db.ObjectId(user),\n\t\t\t\t\tquery = {};\n\n\t\t\t\tswitch (flag) {\n\t\t\t\t\tcase FLAGS.AUTHOR: query.authorId = userId; break;\n\t\t\t\t\tcase FLAGS.RECEIVER: query.receivers = userId; break;\n\t\t\t\t}\n\n\t\t\t\treturn Model\n\t\t\t\t\t.find(Message, query)\n\t\t\t\t\t.sort({ createdAt: -1 })\n\t\t\t\t\t.limit(20)\n\t\t\t\t\t.bindCriteria(criteria);\n\t\t\t}\n\n\t\t\tstatic find(query) {\n\t\t\t\treturn Model.find(Message, query);\n\t\t\t}\n\n\t\t\tstatic findOne(query) {\n\t\t\t\treturn Model.findOne(Message, query);\n\t\t\t}\n\n\t\t\tstatic update() {\n\t\t\t\treturn Model.update.apply(Message, arguments);\n\t\t\t}\n\t\t}\n\n\t\treturn Message;\n\t};\n}());"]}