{"version":3,"sources":["../../src/old/chat.es6"],"names":[],"mappings":"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","file":"chat.js","sourcesContent":["(function () {\n\tvar _             = require('underscore'),\n\t\tutil          = require('util'),\n\t\tdebug         = require('debug')('develop'),\n\t\tdb            = require('./db'),\n\t\tSchemaLoader  = require('./schema'),\n\t\tModel         = require('./model'),\n\t\textend        = require('extend'),\n\t\tQueryResolver = require('./queryResolver'),\n\n\t\tschemaLoader  = new SchemaLoader();\n\n\tvar sl = Array.prototype.slice;\n\n\tmodule.exports = function (options = {}) {\n\t\tvar collectionName = 'chats',\n\t\t\tschema         = schemaLoader.load(__dirname + '/../schema/chat.json');\n\n\t\toptions.collection && (collectionName = options.collection);\n\t\toptions.schema && (schema = extend(true, schema, options.schema));\n\n\t\tclass Chat extends Model {\n\t\t\tdefaults() {\n\t\t\t\treturn schemaLoader.defaults(schema);\n\t\t\t}\n\n\t\t\tconstructor(props) {\n\t\t\t\tsuper(props);\n\n\t\t\t\tthis.setSchema(schema);\n\n\t\t\t\tthis.on('beforeValidate', function () {\n\t\t\t\t\tthis.set('type', this.determinateType());\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tsetCreator(id) {\n\t\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\t\tthis.set('creatorId', db.ObjectId(id));\n\t\t\t\t\tthis.addMember(id);\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tsetTitle(title = '') {\n\t\t\t\tthis.set('title', String(title));\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\taddMember(id) {\n\t\t\t\tvar index, memberId;\n\n\t\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\t\tindex    = this.indexMember(id);\n\t\t\t\t\tmemberId = db.ObjectId(id);\n\n\t\t\t\t\tif (index === -1) {\n\t\t\t\t\t\tthis.get('members').push(memberId);\n\t\t\t\t\t\tthis.$addToSet('members', memberId, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tremoveMember(id) {\n\t\t\t\tvar index = this.indexMember(id);\n\n\t\t\t\tif (~index) {\n\t\t\t\t\tif (this.get('members')[index].equals(this.get('creatorId'))) {\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.get('members').splice(index, 1);\n\t\t\t\t\tthis.$pull('members', db.ObjectId(id));\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tindexMember(id) {\n\t\t\t\tvar index;\n\n\t\t\t\tid = db.ObjectID.isValid(id) ? db.ObjectID(id) : null;\n\n\t\t\t\tindex = _.findIndex(this.get('members'), function (member) {\n\t\t\t\t\treturn member && member.equals(id);\n\t\t\t\t});\n\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\thasMember(id) {\n\t\t\t\treturn !!~this.indexMember(id);\n\t\t\t}\n\n\t\t\tincCountMessages() {\n\t\t\t\tif (typeof this.get('countMessages') !== 'undefined') {\n\t\t\t\t\tthis.set('countMessages', this.get('countMessages'));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcollection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tstatic collection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tstatic schema() {\n\t\t\t\treturn schema;\n\t\t\t}\n\n\t\t\tdeterminateType() {\n\t\t\t\tif (this.get('members').length <= 2) {\n\t\t\t\t\treturn 'private';\n\t\t\t\t}\n\n\t\t\t\tif (this.get('members').length > 2) {\n\t\t\t\t\treturn 'group';\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tstatic fill (props, isAtomic) {\n\t\t\t\tvar model = new Chat();\n\n\t\t\t\tmodel.isNew = false;\n\t\t\t\tmodel.fill(props, !!isAtomic);\n\n\t\t\t\treturn model;\n\t\t\t}\n\n\t\t\tstatic findById(id, criteria = {}) {\n\t\t\t\tvar chatId        = db.ObjectId(id),\n\t\t\t\t\tquery,\n\t\t\t\t\tqueryResolver = new QueryResolver();\n\n\t\t\t\tquery = { _id: chatId };\n\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.findOne()\n\t\t\t\t\t.then(function (result) {\n\t\t\t\t\t\tvar m = Chat.fill(result);\n\n\t\t\t\t\t\treturn result && Chat.fill(result);\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findByOwner(id, creatorId, criteria = {}) {\n\t\t\t\tvar chatId,\n\t\t\t\t\tchatCreatorId,\n\t\t\t\t\tquery,\n\t\t\t\t\tqueryResolver = new QueryResolver();\n\n\t\t\t\tchatId        = db.ObjectId(id);\n\t\t\t\tchatCreatorId = db.ObjectId(creatorId);\n\n\t\t\t\tquery = { _id: chatId, creatorId: chatCreatorId };\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.findOne()\n\t\t\t\t\t.then(function (result) {\n\t\t\t\t\t\treturn result && Chat.fill(result);\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findByMember(id, memberId, criteria = {}) {\n\t\t\t\tvar chatId,\n\t\t\t\t\tchatMemberId,\n\t\t\t\t\tquery,\n\t\t\t\t\tqueryResolver = new QueryResolver();\n\n\t\t\t\tchatId       = db.ObjectId(id);\n\t\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\t\tquery = { _id: chatId, members: chatMemberId };\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.setQuery(query, criteria.filter)\n\t\t\t\t\t.findOne()\n\t\t\t\t\t.then(function (result) {\n\t\t\t\t\t\treturn result && Chat.fill(result);\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findAllByMember(memberId, count, criteria = {}) {\n\t\t\t\tvar chatMemberId,\n\t\t\t\t\tquery,\n\t\t\t\t\tqueryResolver = new QueryResolver();\n\n\t\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\t\tquery = { members: chatMemberId };\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.addQuery(query)\n\t\t\t\t\t.bindCriteria(criteria)\n\t\t\t\t\t.find();\n\t\t\t}\n\n\t\t\tstatic findEqual(chatModel) {\n\t\t\t\tvar queryResolver = new QueryResolver(),\n\t\t\t\t\tquery = {\n\t\t\t\t\t\t_id: db.ObjectId(chatModel.get('_id')),\n\t\t\t\t\t\tmembers: chatModel.get('members').map(db.ObjectId)\n\t\t\t\t\t};\n\n\t\t\t\tqueryResolver.setSchema(schema);\n\n\t\t\t\treturn queryResolver\n\t\t\t\t\t.collection(collectionName)\n\t\t\t\t\t.findOne(query)\n\t\t\t\t\t.then(function (result) {\n\t\t\t\t\t\treturn result && Chat.fill(result);\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic find(query) {\n\t\t\t\treturn Model.find(Chat, query);\n\t\t\t}\n\n\t\t\tstatic findOne(query) {\n\t\t\t\treturn Model.findOne(Chat, query);\n\t\t\t}\n\n\t\t\tstatic update() {\n\t\t\t\treturn Model.update.apply(Model, arguments);\n\t\t\t}\n\t\t}\n\n\t\treturn Chat;\n\t};\n}());"]}