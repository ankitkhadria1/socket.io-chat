{"version":3,"sources":["../../../src/old/client/socket.es6"],"names":[],"mappings":"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","file":"socket.js","sourcesContent":["import ClientError  from '../error';\nimport debugBase    from 'debug';\n\nvar debug = debugBase('develop');\n\nfunction catchErrorMessage(error) {\n\tswitch (error.type) {\n\t\tcase 'validation':\n\t\tcase 'client':\n\t\t\treturn error.message;\n\t\tdefault:\n\t\t\t// TODO: debug(error.stack);\n\t\t\tdebug(error.stack);\n\t\t\treturn 'Unknown error';\n\t}\n}\n\n/**\n * @function socketError\n * @param {String} event\n * @param {Error|String} error\n * @returns {Error}\n */\nfunction socketError(event, error) {\n\tvar sError = new Error();\n\n\tsError.event = String(event);\n\n\tswitch (Object.prototype.toString.call(error)) {\n\t\tcase '[object Error]':\n\t\t\tsError.message = error.message;\n\t\t\tbreak;\n\t\tcase '[object String]':\n\t\t\tsError.message = error;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsError.message = String(error);\n\t}\n\n\treturn sError;\n}\n\nclass ClientSocket {\n\tconstructor() {\n\t\tthis.emitResult.transform = function (data, next) {\n\t\t\tnext(data);\n\t\t};\n\n\t\tthis.emitError.transform = function (data, next) {\n\t\t\tnext(data);\n\t\t};\n\n\t\tthis.emitError.transformOn = (event, cb) => {\n\t\t\tif (!this.emitError.__transforms) {\n\t\t\t\tthis.emitError.__transforms = {}\n\t\t\t}\n\n\t\t\tif (!this.emitError.__transforms[event]) {\n\t\t\t\tthis.emitError.__transforms[event] = [];\n\t\t\t}\n\n\t\t\tthis.emitError.__transforms[event].push(cb);\n\n\t\t\treturn this.emitResult;\n\t\t};\n\n\t\tthis.emitResult.transformOn = (event, cb) => {\n\t\t\tif (!this.emitResult.__transforms) {\n\t\t\t\tthis.emitResult.__transforms = {}\n\t\t\t}\n\n\t\t\tif (!this.emitResult.__transforms[event]) {\n\t\t\t\tthis.emitResult.__transforms[event] = [];\n\t\t\t}\n\n\t\t\tthis.emitResult.__transforms[event].push(cb);\n\n\t\t\treturn this.emitResult;\n\t\t};\n\t}\n\n\temitError(socket, event, data) {\n\t\tvar index      = 0,\n\t\t    transforms = this.emitError.__transforms || {},\n\t\t    transformCb;\n\n\t\tfunction nextTransform(data) {\n\t\t\ttransformCb = transforms[event] ? transforms[event][index] : null;\n\n\t\t\tif (transformCb) {\n\t\t\t\ttransformCb(data, function (data) {\n\t\t\t\t\tindex++;\n\n\t\t\t\t\tif (transforms.length === index) {\n\t\t\t\t\t\tsocket.emit(event, { error: data });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnextTransform(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tsocket.emit(event, { error: data });\n\t\t\t}\n\t\t}\n\n\t\tthis.emitError.transform(data, (data) => {\n\t\t\tnextTransform(data);\n\t\t});\n\t}\n\n\temitResult(socket, event, data) {\n\t\tvar index      = 0,\n\t\t    transforms = this.emitResult.__transforms || {},\n\t\t    transformCb;\n\n\t\tfunction nextTransform(data) {\n\t\t\ttransformCb = transforms[event] ? transforms[event][index] : null;\n\n\t\t\tif (transformCb) {\n\t\t\t\ttransformCb(data, function (data) {\n\t\t\t\t\tindex++;\n\n\t\t\t\t\tif (transforms.length === index) {\n\t\t\t\t\t\tsocket.emit(event, { result: data });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnextTransform(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tsocket.emit(event, { result: data });\n\t\t\t}\n\t\t}\n\n\t\tthis.emitResult.transform(data, (data) => {\n\t\t\tnextTransform(data);\n\t\t});\n\t}\n\n\tonAuthenticate(client, socket, data = {}) {\n\t\tclient.emit(client.EVENTS.AUTHENTICATE, socket, data, (error) => {\n\t\t\tif (error) {\n\t\t\t\treturn this.emitError(socket, 'login', { message: error.message || error });\n\t\t\t}\n\n\t\t\tif (!client.authorize(socket)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tclient.members.add(socket.user, socket);\n\n\t\t\tthis.emitResult(socket, 'login', { user: socket.user });\n\t\t\tthis.emitResult(socket, 'authenticate', { user: socket.user });\n\t\t});\n\t}\n\n\tonCreate(client, socket, data = {}) {\n\t\tclient.create(data, socket.user)\n\t\t\t.then((chat) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.CREATE, { message: 'Chat created', data: chat.toJSON() });\n\n\t\t\t\tclient.rooms.addMembers(\n\t\t\t\t\tchat.get('_id'),\n\t\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t);\n\n\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.JOIN, {\n\t\t\t\t\t\t\tmessage: 'Join to chat',\n\t\t\t\t\t\t\tdata:    chat.toJSON()\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\treturn this.emitError(socket, client.EVENTS.CREATE, { message: error.message });\n\t\t\t});\n\t}\n\n\tonLeave(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\treturn client.leave(chat, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tclient.rooms.removeMember(chat.get('_id'), member);\n\n\t\t\t\tlet receivers = chat.get('members').concat(member),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.leaveMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoLeaved: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWSYSTEMMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message', data: message.toJSON(), chatId: chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.LEAVE, {\n\t\t\t\t\t\tmessage: 'The member leaved',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.LEAVE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonAddMember(client, socket, data = {}) {\n\t\tvar chat, countBefore, countAfter;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\treturn client.addMember(chat, data.member, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet receivers = chat.get('members'),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tclient.rooms.addMembers(chat.get('_id'), member);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.addMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoAdded: socket.user, whomAdded: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.ADDMEMBER, {\n\t\t\t\t\t\tmessage: 'The member added',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.ADDMEMBER, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonRemoveMember(client, socket, data = {}) {\n\t\tvar chat, countBefore, countAfter;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\treturn client.removeMember(chat, data.member, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tclient.rooms.removeMember(chat.get('_id'), member);\n\n\t\t\t\tlet receivers = chat.get('members').concat(member),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.removeMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoRemove: socket.user, whomRemove: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.REMOVEMEMBER, {\n\t\t\t\t\t\tmessage: 'The member removed',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.REMOVEMEMBER, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonNewMessage(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\treturn client.newMessage(chat, data, socket.user);\n\t\t\t})\n\t\t\t.then((message) => {\n\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\tmessage: 'New message',\n\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.NEWMESSAGE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesLast(client, socket, data = {}) {\n\t\tclient.findLastMessages(data.chatId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESLAST, {\n\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\tdata:   messages\n\t\t\t\t})\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESLAST, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesFrom(client, socket, data = {}) {\n\t\tclient.findFromMessages(data.chatId, data.messageId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESFROM, {\n\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\tdata:   messages\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESFROM, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesAt(client, socket, data = {}) {\n\t\tclient.findAtMessages(data.chatId, data.messageId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESAT, { chatId: data.chatId, data: messages });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESAT, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindChat(client, socket, data = {}) {\n\t\tclient.findChatById(socket.user, data.chatId)\n\t\t\t.then((chat) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDCHAT, { data: chat });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDCHAT, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindChats(client, socket, data = {}) {\n\t\tclient.findChats(socket.user, data.limit, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((chats) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDCHATS, { data: chats });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDCHATS, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonChangeTitle(client, socket, data = {}) {\n\t\tvar oldTitle;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((chat) => {\n\t\t\t\tif (!chat) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\toldTitle = String(chat.get('title'));\n\n\t\t\t\treturn client.changeTitle(chat, data.title, socket.user)\n\t\t\t})\n\t\t\t.then((chat) => {\n\t\t\t\tlet receivers = chat.get('members'),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.changeTitle) {\n\t\t\t\t\tclient.newSystemMessage(chat, {\n\t\t\t\t\t\tchanged: socket.user, oldTitle: oldTitle, newTitle: chat.get('title')\n\t\t\t\t\t}).then((message) => {\n\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.CHANGETITLE, {\n\t\t\t\t\t\tmessage: 'Title changed',\n\t\t\t\t\t\tdata:    chat.get('title'),\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.CHANGETITLE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonReadMessage(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tif (!data.messagesId) {\n\t\t\tmessagesId = [];\n\t\t}\n\n\t\tdata.messagesId = data.messagesId.slice(0, 10);\n\t\t\n\t\tPromise.all([\n\t\t\tclient.model('chat').findOne({ _id: data.chatId, members: socket.user }).exec(),\n\t\t\tclient.model('message').find({ \n\t\t\t\t_id: { $in: data.messagesId }, \n\t\t\t\tchatId: data.chatId, \n\t\t\t\treceivers: socket.user,\n\t\t\t\tread: { $nin: data.messagesId }\n\t\t\t}).exec()\n\t\t])\n\t\t.then((results) => {\n\t\t\tvar messages = results[1];\n\t\t\tchat = results[0];\n\n\t\t\tif (!chat) {\n\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t}\n\n\t\t\treturn Promise.all(messages.map(function (message) {\n\t\t\t\treturn client.readMessage(chat, message, socket.user);\n\t\t\t}));\n\t\t})\n\t\t.then((results) => {\n\t\t\tsockets = client.members.get(chat.get('members'));\n\t\t\tsockets.forEach((socket) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.READMESSAGE, {\n\t\t\t\t\tmessage:   'Message readed',\n\t\t\t\t\tmessagesId: results.map(function (message) { return message._id }),\n\t\t\t\t\tchatId:  \tchat._id\n\t\t\t\t});\n\t\t\t});\n\t\t})\n\t\t.catch((error) => {\n\t\t\tthis.emitError(socket, client.EVENTS.READMESSAGE, { message: catchErrorMessage(error) });\n\t\t});\n\t}\n}\n\nexport default ClientSocket;"]}