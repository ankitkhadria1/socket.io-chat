{"version":3,"sources":["../../src/old/model.es6"],"names":[],"mappings":"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","file":"model.js","sourcesContent":["import _ \t\t\t\tfrom 'underscore';\nimport db \t\t\t\tfrom './db';\nimport { Validator } \tfrom 'jsonschema';\nimport { EventEmitter } from 'events';\nimport debugBase \t\tfrom 'debug';\nimport schemaLoader \tfrom './schema';\nimport QueryResolver    from './queryResolver2';\n\nvar debug = debugBase('develop');\nvar sl     = Array.prototype.slice;\nvar typeOf = function (object) {\n\treturn Object.prototype.toString.call(object).replace(/\\[object\\s(\\w+)\\]/, '$1');\n};\n\nclass Model extends EventEmitter {\n\tconstructor(props = {}) {\n\t\tsuper();\n\n\t\tthis._id = new db.ObjectID();\n\t\tthis.isNew = true;\n\n\t\t_.each(this.defaults(), (value, key) => {\n\t\t\tthis[key] = props[key] ? props[key] : value;\n\t\t});\n\n\t\tthis.__defaultAttrs  = Object.keys(this.defaults());\n\t\tthis.__readonlyAttrs = [];\n\t\tthis.__atomics       = {};\n\t}\n\n\tsave() {\n\t\tvar cb = sl.call(arguments, -1)[0];\n\n\t\tif (!this.isNew) {\n\t\t\treturn this.update.apply(this, arguments);\n\t\t}\n\n\t\tif (this.isValid()) {\n\t\t\tthis.set('_id', new db.ObjectID());\n\t\t\tthis.emit('beforeSave');\n\n\t\t\tdb.getConnect((connect) => {\n\t\t\t\tconnect.collection(this.collection()).insert(this.toJSON(), {}, (error, result) => {\n\t\t\t\t\tif (!error) {\n\t\t\t\t\t\tthis.isNew = false;\n\t\t\t\t\t\tthis.__atomics = {};\n\t\t\t\t\t}\n\n\t\t\t\t\tcb && cb(error, this);\n\t\t\t\t});\n\t\t\t\tthis.emit('save');\n\t\t\t});\n\t\t} else {\n\t\t\tcb(this.validationError);\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tupdate() {\n\t\tvar query, data, cb, modelId;\n\n\t\tmodelId = db.ObjectID(this.get('_id'));\n\t\tquery   = { _id: modelId };\n\t\tcb      = sl.call(arguments, -1)[0];\n\t\tdata    = {};\n\n\t\tif (this.isValid()) {\n\t\t\t_.each(this.__atomics, function (atomic, key) {\n\t\t\t\tif (Object.keys(atomic).length) {\n\t\t\t\t\tdelete atomic._id;\n\n\t\t\t\t\tdata[key] = atomic;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!Object.keys(data).length) {\n\t\t\t\treturn cb && cb(null, this);\n\t\t\t}\n\n\t\t\tdb.getConnect((connect) => {\n\t\t\t\t//debug('update', query);\n\n\t\t\t\tconnect.collection(this.collection()).update(query, data, (error, result) => {\n\t\t\t\t\tif (!error) {\n\t\t\t\t\t\tthis.isNew = false;\n\t\t\t\t\t\tthis.__atomics = {};\n\t\t\t\t\t}\n\n\t\t\t\t\tcb && cb(error, this);\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\tcb(this.validationError);\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tisValid() {\n\t\tvar result, error;\n\n\t\tresult = this.validate();\n\n\t\tif (result) {\n\t\t\terror      = new Error(result.message);\n\t\t\terror.type = 'validation';\n\n\t\t\tthis.validationError = error;\n\t\t}\n\n\t\treturn !result;\n\t}\n\n\tvalidate() {\n\t\tvar validator = new Validator(),\n\t\t\tresult    = validator.validate(this.toJSON(), this.getSchema());\n\n\t\tthis.emit('beforeValidate');\n\n\t\tif (result.errors.length) {\n\t\t\treturn new Error(result.errors[0].stack);\n\t\t}\n\n\t\tthis.emit('validate');\n\n\t\treturn null;\n\t}\n\n\tsetSchema(schema) {\n\t\tthis.schema = schema;\n\n\t\tvar readonlyAttrs = [];\n\t\tvar path          = [];\n\n\t\tfunction walk(properties) {\n\t\t\t_.each(properties, (prop, key) => {\n\t\t\t\tpath.push(key);\n\n\t\t\t\tif (prop.readonly) {\n\t\t\t\t\treadonlyAttrs.push(path.join('.'));\n\t\t\t\t}\n\n\t\t\t\tif (prop.properties) {\n\t\t\t\t\twalk(prop.properties);\n\t\t\t\t} else {\n\t\t\t\t\tpath = [];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\twalk(this.schema.properties);\n\n\t\tthis.__readonlyAttrs = readonlyAttrs;\n\t}\n\n\tgetSchema() {\n\t\treturn this.schema;\n\t}\n\n\ttoJSON() {\n\t\treturn _.clone(_.pick(this, this.__defaultAttrs));\n\t}\n\n\tfill(key, value, isAtomic = false) {\n\t\tif (_.isBoolean(arguments[1])) {\n\t\t\t_.each(key, (value, key1) => {\n\t\t\t\tthis.fill(key1, value);\n\t\t\t});\n\t\t}\n\n\t\tif (~this.__defaultAttrs.indexOf(key)) {\n\t\t\tthis[key] = value;\n\n\t\t\tif (isAtomic) {\n\t\t\t\tthis.__addAtomic('set', key, value);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tset(key, value, path = []) {\n\t\tif (arguments.length === 1) {\n\t\t\t_.each(key, (value, key) => {\n\t\t\t\tthis.set(key, value, path.push(key));\n\t\t\t});\n\t\t} else {\n\t\t\tpath = [key];\n\t\t}\n\n\t\tif (~this.__defaultAttrs.indexOf(key) && !~this.__readonlyAttrs.indexOf(path.join('.'))) {\n\t\t\tthis[key] = value;\n\n\t\t\tif (~['Number', 'String', 'Data', 'Boolean', 'Object', 'Null'].indexOf(typeOf(value))) {\n\t\t\t\tthis.__addAtomic('set', key, value);\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tget(key) {\n\t\tif (~this.__defaultAttrs.indexOf(key)) {\n\t\t\treturn this[key];\n\t\t}\n\t}\n\n\t$push(field, value, isEach = false) {\n\t\tisEach\n\t\t\t? this.get(field) && this.__addAtomic('push', field, { $each: value })\n\t\t\t: this.get(field) && this.__addAtomic('push', field, value);\n\t}\n\n\t$addToSet(field, value, isEach = false) {\n\t\tisEach\n\t\t\t? this.get(field) && this.__addAtomic('addToSet', field,{ $each: value })\n\t\t\t: this.get(field) && this.__addAtomic('addToSet', field, value);\n\t}\n\n\t$pull(field, value) {\n\t\tthis.get(field) && this.__addAtomic('pull', field, value);\n\t}\n\n\t__addAtomic(type, field, value) {\n\t\tif (!this.__atomics['$' + type]) {\n\t\t\tthis.__atomics['$' + type] = {};\n\t\t}\n\n\t\tif (_.isObject(value) && Object.keys(value).length === 1 && /^\\$/.test(Object.keys(value)[0])) {\n\t\t\tswitch (Object.keys(value)[0]) {\n\t\t\t\tcase '$each': {\n\t\t\t\t\tif (!this.__atomics['$' + type][field]) {\n\t\t\t\t\t\tthis.__atomics['$' + type][field] = { $each: [] }\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.__atomics['$' + type][field].$each.push(value.$each);\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthis.__atomics['$' + type][field] = value;\n\t\t}\n\n\t}\n\n\tdestroy() {\n\t\tthis.removeAllListeners();\n\t\tthis.emit('destroy');\n\t}\n\n\tstatic find(Model, query) {\n\t\tvar queryResolver = new QueryResolver(Model);\n\n\t\treturn queryResolver.find(query);\n\t}\n\n\tstatic findOne(Model, query) {\n\t\tvar queryResolver = new QueryResolver(Model);\n\n\t\treturn queryResolver.findOne(query);\n\t}\n\n\tstatic update() {\n\t\tdb.getConnect((connect) => {\n\t\t\tlet collection = connect.collection(this.collection());\n\t\t\t\n\t\t\tcollection.update.apply(collection, Array.prototype.slice.call(arguments));\n\t\t})\n\t}\n}\n\nexport default Model;"]}