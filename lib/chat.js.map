{"version":3,"sources":["../src/chat.es6"],"names":[],"mappings":"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","file":"src/chat.es6","sourcesContent":["var _ = require('lodash'),\n\tutil = require('util'),\n\tdb = require('./db'),\n\tSchemaLoader = require('./schema'),\n\tModel = require('./model'),\n\n\tschemaLoader = new SchemaLoader(),\n\tschema = schemaLoader.load(__dirname + '/../schema/chat.json');\n\nvar sl = Array.prototype.slice;\n\nmodule.exports = function (options) {\n\tvar collectionName;\n\n\tcollectionName = options.collection || 'chats';\n\n\tclass Chat extends Model {\n\t\tdefaults() {\n\t\t\treturn {\n\t\t\t\t_id:            null,\n\t\t\t\tname:           '',\n\t\t\t\ttitle:          '',\n\t\t\t\tcreatorId:      null,\n\t\t\t\tmembers:        [],\n\t\t\t\tcreatedAt:      null,\n\t\t\t\ttype:           'private',\n\t\t\t\tsystemMessages: {\n\t\t\t\t\taddMember:    false,\n\t\t\t\t\tremoveMember: false,\n\t\t\t\t\tchangeTitle:  false\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconstructor(props) {\n\t\t\tsuper(props);\n\n\t\t\tthis.setSchema(schema);\n\n\t\t\tthis.on('beforeValidate', function () {\n\t\t\t\tif (!this.get('createdAt')) {\n\t\t\t\t\tthis.set('createdAt', new Date());\n\t\t\t\t}\n\n\t\t\t\tthis.set('type', this.determinateType());\n\t\t\t});\n\t\t}\n\n\t\tsetCreator(id) {\n\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\tthis.set('creatorId', id);\n\t\t\t\tthis.addMember(id);\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetTitle (title = '') {\n\t\t\tthis.set('title', String(title));\n\n\t\t\treturn this;\n\t\t}\n\n\t\taddMember(id) {\n\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\tvar index = this.indexMember(id);\n\n\t\t\t\tif (index === -1) {\n\t\t\t\t\tthis.get('members').push(db.ObjectId(id));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tremoveMember(id) {\n\t\t\tvar index = this.indexMember(id);\n\n\t\t\tif (~index) {\n\t\t\t\tif (this.get('members')[index].equals(this.get('creatorId'))) {\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\n\t\t\t\tthis.get('members').splice(index, 1);\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tindexMember(id) {\n\t\t\tvar index;\n\n\t\t\tid = db.ObjectID.isValid(id) ? db.ObjectID(id) : null;\n\n\t\t\tindex = _.findIndex(this.get('members'), function (member) {\n\t\t\t\treturn member && member.equals(id);\n\t\t\t});\n\n\t\t\treturn index;\n\t\t}\n\n\t\thasMember(id) {\n\t\t\treturn !!~this.indexMember(id);\n\t\t}\n\n\t\tcollection() {\n\t\t\treturn collectionName;\n\t\t}\n\n\t\tdeterminateType() {\n\t\t\tif (this.get('members').length <= 2) {\n\t\t\t\treturn 'private';\n\t\t\t}\n\n\t\t\tif (this.get('members').length > 2) {\n\t\t\t\treturn 'group';\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\tstatic findById(id) {\n\t\t\tvar chatId = db.ObjectId(id);\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tconnect.collection(collectionName).findOne({ _id: chatId }, function (error, result) {\n\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tstatic findByOwner(id, creatorId) {\n\t\t\tvar chatId, chatCreatorId, criteria;\n\n\t\t\tchatId        = db.ObjectId(id);\n\t\t\tchatCreatorId = db.ObjectId(creatorId);\n\n\t\t\tcriteria = { _id: chatId, creatorId: chatCreatorId };\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tconnect.collection(collectionName).findOne(criteria, function (error, result) {\n\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tstatic findByMember(id, memberId) {\n\t\t\tvar chatId, chatMemberId, criteria;\n\n\t\t\tchatId       = db.ObjectId(id);\n\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\tcriteria = { _id: chatId, members: chatMemberId };\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tconnect.collection(collectionName).findOne(criteria, function (error, result) {\n\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tstatic findAllByMember(memberId) {\n\t\t\tvar chatMemberId, criteria;\n\n\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\tcriteria = { members: chatMemberId };\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tconnect.collection(collectionName).find(criteria).toArray(function (error, result) {\n\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\treturn Chat;\n};"]}