{"version":3,"sources":["../src/chat.es6"],"names":[],"mappings":"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","file":"src/chat.es6","sourcesContent":["(function () {\n\tvar _            = require('underscore'),\n\t\tutil         = require('util'),\n\t\tdb           = require('./db'),\n\t\tSchemaLoader = require('./schema'),\n\t\tModel        = require('./model'),\n\n\t\tschemaLoader = new SchemaLoader(),\n\t\tschema       = schemaLoader.load(__dirname + '/../schema/chat.json');\n\n\tvar sl = Array.prototype.slice;\n\n\tmodule.exports = function (options) {\n\t\tvar collectionName;\n\n\t\tcollectionName = options.collection || 'chats';\n\n\t\tclass Chat extends Model {\n\t\t\tdefaults() {\n\t\t\t\treturn {\n\t\t\t\t\t_id:            null,\n\t\t\t\t\tname:           '',\n\t\t\t\t\ttitle:          '',\n\t\t\t\t\tcreatorId:      null,\n\t\t\t\t\tmembers:        [],\n\t\t\t\t\tcreatedAt:      null,\n\t\t\t\t\ttype:           'private',\n\t\t\t\t\tsystemMessages: {\n\t\t\t\t\t\taddMember:    false,\n\t\t\t\t\t\tremoveMember: false,\n\t\t\t\t\t\tchangeTitle:  false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconstructor(props) {\n\t\t\t\tsuper(props);\n\n\t\t\t\tthis.setSchema(schema);\n\n\t\t\t\tthis.on('beforeValidate', function () {\n\t\t\t\t\tif (!this.get('createdAt')) {\n\t\t\t\t\t\tthis.set('createdAt', new Date());\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.set('type', this.determinateType());\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tsetCreator(id) {\n\t\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\t\tthis.set('creatorId', id);\n\t\t\t\t\tthis.addMember(id);\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tsetTitle(title = '') {\n\t\t\t\tthis.set('title', String(title));\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\taddMember(id) {\n\t\t\t\tvar index, memberId;\n\n\t\t\t\tif (db.ObjectID.isValid(id)) {\n\t\t\t\t\tindex    = this.indexMember(id);\n\t\t\t\t\tmemberId = db.ObjectId(id);\n\n\t\t\t\t\tif (index === -1) {\n\t\t\t\t\t\tthis.get('members').push(memberId);\n\t\t\t\t\t\tthis.$addToSet('members', memberId);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tremoveMember(id) {\n\t\t\t\tvar index = this.indexMember(id);\n\n\t\t\t\tif (~index) {\n\t\t\t\t\tif (this.get('members')[index].equals(this.get('creatorId'))) {\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.get('members').splice(index, 1);\n\t\t\t\t\tthis.$pull('members', db.ObjectId(id));\n\t\t\t\t}\n\n\t\t\t\treturn this;\n\t\t\t}\n\n\t\t\tindexMember(id) {\n\t\t\t\tvar index;\n\n\t\t\t\tid = db.ObjectID.isValid(id) ? db.ObjectID(id) : null;\n\n\t\t\t\tindex = _.findIndex(this.get('members'), function (member) {\n\t\t\t\t\treturn member && member.equals(id);\n\t\t\t\t});\n\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\thasMember(id) {\n\t\t\t\treturn !!~this.indexMember(id);\n\t\t\t}\n\n\t\t\tcollection() {\n\t\t\t\treturn collectionName;\n\t\t\t}\n\n\t\t\tdeterminateType() {\n\t\t\t\tif (this.get('members').length <= 2) {\n\t\t\t\t\treturn 'private';\n\t\t\t\t}\n\n\t\t\t\tif (this.get('members').length > 2) {\n\t\t\t\t\treturn 'group';\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tstatic findById(id) {\n\t\t\t\tvar chatId = db.ObjectId(id);\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName).findOne({ _id: chatId }, function (error, result) {\n\t\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findByOwner(id, creatorId) {\n\t\t\t\tvar chatId, chatCreatorId, criteria;\n\n\t\t\t\tchatId        = db.ObjectId(id);\n\t\t\t\tchatCreatorId = db.ObjectId(creatorId);\n\n\t\t\t\tcriteria = { _id: chatId, creatorId: chatCreatorId };\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName).findOne(criteria, function (error, result) {\n\t\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findByMember(id, memberId) {\n\t\t\t\tvar chatId, chatMemberId, criteria;\n\n\t\t\t\tchatId       = db.ObjectId(id);\n\t\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\t\tcriteria = { _id: chatId, members: chatMemberId };\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName).findOne(criteria, function (error, result) {\n\t\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t\t: result\n\t\t\t\t\t\t\t\t? resolve(new Chat().set(result))\n\t\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tstatic findAllByMember(memberId) {\n\t\t\t\tvar chatMemberId, criteria;\n\n\t\t\t\tchatMemberId = db.ObjectId(memberId);\n\n\t\t\t\tcriteria = { members: chatMemberId };\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\t\tconnect.collection(collectionName).find(criteria).toArray(function (error, result) {\n\t\t\t\t\t\t\treturn error\n\t\t\t\t\t\t\t\t? reject(error)\n\t\t\t\t\t\t\t\t: resolve(result);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn Chat;\n\t};\n}());"]}