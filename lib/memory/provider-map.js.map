{"version":3,"sources":["../../src/memory/provider-map.es6"],"names":[],"mappings":"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","file":"provider-map.js","sourcesContent":["import { debug } from '../debug';\nimport Provider  from './provider';\n\nconst DEFAULT_TTL = 360000;\n\nclass ProviderMap extends Provider {\n\tconstructor(options = {}) {\n\t\tsuper();\n\n\t\tthis.chatTtl       = options.chatTtl || DEFAULT_TTL;\n\t\tthis.maxCountChats = options.maxCountChats || null;\n\n\t\tthis.chatsMap    = new Map();\n\t\tthis.messagesMap = new Map();\n\n\t\tthis._timeoutid = null;\n\t}\n\n\tupdateNear() {\n\t\tthis._timeoutid = setTimeout(function () {}, 1);\n\t}\n\n\thasChat(chatModel) {\n\t\t// TODO: strict validate for chatModel? this.chatmap.get(Id) === chatModel\n\t\treturn chatModel && this.chatsMap.has(String(chatModel._id));\n\t}\n\n\taddChat(chatModel) {\n\t\tif (this.maxCountChats !== null && this.chatsMap.size() > this.maxCountChats) {\n\t\t\tlet oldTimestamp = Date.now();\n\t\t\tlet oldId = null;\n\n\t\t\tfor (wrap of this.chatsMap.values()) {\n\t\t\t\tif (wrap.timestamp + wrap.ttl < oldTimestamp) {\n\t\t\t\t\toldTimestamp = wrap.timestamp + wrap.ttl;\n\t\t\t\t\toldId = String(wrap.model._id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toldId && this.dumpAndClear(oldId);\n\t\t}\n\n\t\tif (!chatModel) {\n\t\t\tdebug('ProviderMap addChat: chat model is empty');\n\t\t\treturn this;\n\t\t}\n\n\t\tif (this.chatsMap.has(String(chatModel._id))) {\n\t\t\tdebug('ProviderMap addChat: override exists chat in memory');\n\t\t}\n\n\t\tthis.chatsMap.set(String(chatModel._id), { model: chatModel, ttl: this.chatTtl, timestamp: Date.now() });\n\n\t\treturn this;\n\t}\n\n\tclearChat(id) {\n\t\tthis.chatsMap.delete(String(id));\n\n\t\treturn this;\n\t}\n\n\tgetChat(id) {\n\t\tlet wrap = this.chatsMap.get(String(id));\n\n\t\tif (wrap) {\n\t\t\tif (wrap.timestamp + wrap.chatTtl < Date.now()) {\n\t\t\t\tthis.dumpAndClear(id);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\treturn wrap;\n\t}\n\n\tdumpChat(id) {\n\t\tlet wrap = this.getChat(id);\n\n\t\tif (!wrap) {\n\t\t\tdebug('ProviderMap addChat: dump fail, chat not found');\n\t\t\treturn this;\n\t\t}\n\n\t\twrap.model.save();\n\n\t\treturn this;\n\t}\n\n\tdumpAndClear(id) {\n\t\tthis.dumpChat(id);\n\t\tthis.clearChat(id);\n\t}\n}\n\nexport default ProviderMap;"]}