{"version":3,"sources":["../../src/memory/provider-map.es6"],"names":[],"mappings":"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","file":"provider-map.js","sourcesContent":["import { debug } from '../debug';\nimport Provider  from './provider';\n\nconst DEFAULT_TTL = 360000;\n\nclass ProviderMap extends Provider {\n\tconstructor(options = {}) {\n\t\tsuper();\n\n\t\tthis.chatTtl       = options.chatTtl || DEFAULT_TTL;\n\t\tthis.maxCountChats = options.maxCountChats || null;\n\n\t\tthis.chatsMap    = new Map();\n\t\tthis.messagesMap = new Map();\n\n\t\tthis._timeoutid = null;\n\t}\n\n\tupdateNear() {\n\t\tthis._timeoutid = setTimeout(function () {}, 1);\n\t}\n\n\thasChat(chatModel) {\n\t\t// TODO: strict validate for chatModel? this.chatmap.get(Id) === chatModel\n\t\treturn chatModel && this.chatsMap.has(String(chatModel._id));\n\t}\n\n\taddChat(chatModel) {\n\t\tif (this.maxCountChats !== null && this.chatsMap.size() > this.maxCountChats) {\n\t\t\tlet oldTimestamp = Date.now();\n\t\t\tlet oldId = null;\n\n\t\t\tfor (wrap of this.chatsMap.values()) {\n\t\t\t\tif (wrap.timestamp + wrap.ttl < oldTimestamp) {\n\t\t\t\t\toldTimestamp = wrap.timestamp + wrap.ttl;\n\t\t\t\t\toldId = String(wrap.model._id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toldId && this.dumpAndClear(oldId);\n\t\t}\n\n\t\tif (!chatModel) {\n\t\t\tdebug('ProviderMap addChat: chat model is empty');\n\t\t\treturn this;\n\t\t}\n\n\t\tif (this.chatsMap.has(String(chatModel._id))) {\n\t\t\tdebug('ProviderMap addChat: override exists chat in memory');\n\t\t}\n\n\t\tthis.chatsMap.set(String(chatModel._id), { model: chatModel, ttl: this.chatTtl, timestamp: Date.now() });\n\n\t\treturn this;\n\t}\n\n\tclearChat(id) {\n\t\tthis.chatsMap.delete(String(id));\n\n\t\treturn this;\n\t}\n\n\tgetChat(id) {\n\t\tlet wrap = this.chatsMap.get(String(id));\n\n\t\tif (wrap) {\n\t\t\tif (wrap.timestamp + wrap.chatTtl < Date.now()) {\n\t\t\t\tthis.dumpAndClear(id);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\treturn wrap;\n\t}\n\n\tdumpChat(id) {\n\t\tlet wrap = this.getChat(id);\n\n\t\tif (!wrap) {\n\t\t\tdebug('ProviderMap addChat: dump fail, chat not found');\n\t\t\treturn this;\n\t\t}\n\n\t\twrap.model.save();\n\n\t\treturn this;\n\t}\n\n\tdumpAndClear(id) {\n\t\tthis.dumpChat(id);\n\t\tthis.clearChat(id);\n\t}\n}\n\nexport default ProviderMap;"]}