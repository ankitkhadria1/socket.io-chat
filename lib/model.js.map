{"version":3,"sources":["../src/model.es6"],"names":[],"mappings":"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","file":"src/model.es6","sourcesContent":["var _ = require('lodash'),\n\tdb = require('./db'),\n\tValidator = require('jsonschema').Validator,\n\tEventEmitter = require('events').EventEmitter;\n\nvar sl = Array.prototype.slice;\n\nclass Model extends EventEmitter {\n\tconstructor(props = {}) {\n\t\tsuper();\n\n\t\t_.each(this.defaults(), (value, key) => {\n\t\t\tthis[key] = props[key] ? props[key] : value;\n\t\t});\n\t}\n\n\tsave() {\n\t\tvar cb = sl.call(arguments, -1)[0];\n\n\t\tif (this.isValid()) {\n\t\t\tthis.set('_id', new db.ObjectID());\n\t\t\tthis.emit('beforeSave');\n\n\t\t\tdb.getConnect((connect) => {\n\t\t\t\tconnect.collection(this.collection()).insertOne(this.toJSON(), {}, cb);\n\t\t\t\tthis.emit('save');\n\t\t\t});\n\t\t} else {\n\t\t\tcb(new Error(this.validationError.message));\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tupdate() {\n\t\tvar data, cb, modelId;\n\n\t\tmodelId = db.ObjectID(this.get('_id'));\n\t\tdata    = this.toJSON();\n\t\tcb      = sl.call(arguments, -1)[0];\n\n\t\tdelete data._id;\n\n\t\tdb.getConnect((connect) => {\n\t\t\tconnect.collection(this.collection()).updateOne({ _id: modelId }, data, cb);\n\t\t});\n\n\t\treturn this;\n\t}\n\n\tisValid() {\n\t\tvar result;\n\n\t\tresult = this.validate();\n\n\t\tif (result) {\n\t\t\tthis.validationError = result;\n\t\t}\n\n\t\treturn !result;\n\t}\n\n\tvalidate() {\n\t\tvar validator = new Validator(),\n\t\t    result    = validator.validate(this.toJSON(), this.getSchema());\n\n\t\tthis.emit('beforeValidate');\n\n\t\tif (result.errors.length) {\n\t\t\treturn new Error(result.errors[0].stack);\n\t\t}\n\n\t\tthis.emit('validate');\n\n\t\treturn null;\n\t}\n\n\tsetSchema(schema) {\n\t\tthis.schema = schema;\n\t}\n\n\tgetSchema() {\n\t\treturn this.schema;\n\t}\n\n\ttoJSON() {\n\t\treturn _.clone(_.pick(this, Object.keys(this.defaults())));\n\t}\n\n\tset(key, value) {\n\t\tif (arguments.length === 1) {\n\t\t\t_.each(key, (value, key) => {\n\t\t\t\tthis.set(key, value);\n\t\t\t});\n\t\t}\n\n\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\tthis[key] = value;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tget(key) {\n\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\treturn this[key];\n\t\t}\n\t}\n\n\tdestroy() {\n\t\tthis.removeAllListeners();\n\t\tthis.emit('destroy');\n\t}\n}\n\nmodule.exports = Model;"]}