{"version":3,"sources":["../src/model.es6"],"names":[],"mappings":"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","file":"src/model.es6","sourcesContent":["(function () {\n\tvar _            = require('lodash'),\n\t\tdb           = require('./db'),\n\t\tValidator    = require('jsonschema').Validator,\n\t\tEventEmitter = require('events').EventEmitter,\n\t\tdebug        = require('debug')('develop');\n\n\tvar sl     = Array.prototype.slice;\n\tvar typeOf = function (object) {\n\t\treturn Object.prototype.toString.call(object).replace(/\\[object\\s(\\w+)\\]/, '$1');\n\t};\n\n\tclass Model extends EventEmitter {\n\t\tconstructor(props = {}) {\n\t\t\tsuper();\n\n\t\t\t_.each(this.defaults(), (value, key) => {\n\t\t\t\tthis[key] = props[key] ? props[key] : value;\n\t\t\t});\n\n\t\t\tthis.__atomics = {};\n\t\t}\n\n\t\tsave() {\n\t\t\tvar cb = sl.call(arguments, -1)[0];\n\n\t\t\tif (this.isValid()) {\n\t\t\t\tthis.set('_id', new db.ObjectID());\n\t\t\t\tthis.emit('beforeSave');\n\n\t\t\t\tdb.getConnect((connect) => {\n\t\t\t\t\tconnect.collection(this.collection()).insert(this.toJSON(), {}, (error, result) => {\n\t\t\t\t\t\tif (!error) {\n\t\t\t\t\t\t\tthis.__atomics = {};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcb(error, this);\n\t\t\t\t\t});\n\t\t\t\t\tthis.emit('save');\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tcb(this.validationError);\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tupdate() {\n\t\t\tvar query, data, cb, modelId;\n\n\t\t\tmodelId = db.ObjectID(this.get('_id'));\n\t\t\tquery   = { _id: modelId };\n\t\t\tcb      = sl.call(arguments, -1)[0];\n\t\t\tdata    = {};\n\n\t\t\t_.each(this.__atomics, function (atomic, key) {\n\t\t\t\tif (Object.keys(atomic).length) {\n\t\t\t\t\tdelete atomic._id;\n\n\t\t\t\t\tdata[key] = atomic;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!Object.keys(data).length) {\n\t\t\t\treturn cb(null, this);\n\t\t\t}\n\n\t\t\tdb.getConnect((connect) => {\n\t\t\t\t//debug('update', query);\n\n\t\t\t\tconnect.collection(this.collection()).update(query, data, (error, result) => {\n\t\t\t\t\tif (!error) {\n\t\t\t\t\t\tthis.__atomics = {};\n\t\t\t\t\t}\n\n\t\t\t\t\tcb(error, this);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn this;\n\t\t}\n\n\t\tisValid() {\n\t\t\tvar result, error;\n\n\t\t\tresult = this.validate();\n\n\t\t\tif (result) {\n\t\t\t\terror      = new Error(result.message);\n\t\t\t\terror.type = 'validation';\n\n\t\t\t\tthis.validationError = error;\n\t\t\t}\n\n\t\t\treturn !result;\n\t\t}\n\n\t\tvalidate() {\n\t\t\tvar validator = new Validator(),\n\t\t\t\tresult    = validator.validate(this.toJSON(), this.getSchema());\n\n\t\t\tthis.emit('beforeValidate');\n\n\t\t\tif (result.errors.length) {\n\t\t\t\treturn new Error(result.errors[0].stack);\n\t\t\t}\n\n\t\t\tthis.emit('validate');\n\n\t\t\treturn null;\n\t\t}\n\n\t\tsetSchema(schema) {\n\t\t\tthis.schema = schema;\n\t\t}\n\n\t\tgetSchema() {\n\t\t\treturn this.schema;\n\t\t}\n\n\t\ttoJSON() {\n\t\t\treturn _.clone(_.pick(this, Object.keys(this.defaults())));\n\t\t}\n\n\t\tset(key, value) {\n\t\t\tif (arguments.length === 1) {\n\t\t\t\t_.each(key, (value, key) => {\n\t\t\t\t\tthis.set(key, value);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\t\tthis[key] = value;\n\n\t\t\t\tif (~['Number', 'String', 'Data', 'Boolean', 'Object', 'Null'].indexOf(typeOf(value))) {\n\t\t\t\t\tthis.__addAtomic('set', key, value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tget(key) {\n\t\t\tif (~Object.keys(this.defaults()).indexOf(key)) {\n\t\t\t\treturn this[key];\n\t\t\t}\n\t\t}\n\n\t\t$push(field, value) {\n\t\t\tthis.get(field) && this.__addAtomic('push', field, value);\n\t\t}\n\n\t\t$addToSet(field, value) {\n\t\t\tthis.get(field) && this.__addAtomic('addToSet', field, value);\n\t\t}\n\n\t\t$pull(field, value) {\n\t\t\tthis.get(field) && this.__addAtomic('pull', field, value);\n\t\t}\n\n\t\t__addAtomic(type, field, value) {\n\t\t\tif (!this.__atomics['$' + type]) {\n\t\t\t\tthis.__atomics['$' + type] = {};\n\t\t\t}\n\n\t\t\tthis.__atomics['$' + type][field] = value;\n\t\t}\n\n\t\tdestroy() {\n\t\t\tthis.removeAllListeners();\n\t\t\tthis.emit('destroy');\n\t\t}\n\t}\n\n\tmodule.exports = Model;\n}());"]}